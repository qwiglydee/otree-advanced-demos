{{ block styles }}
<link href="{{ static 'fullscreen.css' }}" rel="stylesheet">
<link href="{{ static 'enhancements.css' }}" rel="stylesheet">
<link href="{{ static 'xfade.css' }}" rel="stylesheet">
<link href="{{ static 'progress2.css' }}" rel="stylesheet">
<link href="{{ static 'spinner-pulse.css' }}" rel="stylesheet">
<style>
    /* shuld be fixed size to avoid readjusting page layout when changing */
    footer {
        height: 10rem;
    }
</style>
{{ endblock }}

{{ block content }}

<header>
    <my-progress max="{{C.NUM_TRIALS}}" ticks="1" value="vars.progress.completed"
        value2="vars.trial.iteration"></my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.fading">
    <div ot-display="aim" class="fs-1">âœ›</div>
    <div ot-display="stimulus" class="fs-2">
        <span ot-text="vars.trial.expression"></span>
        =
        <span ot-text="vars.trial.suggestion"></span>
    </div>
    <div ot-display="responding" class="fs-1">?</div>
</main>

<footer>
    <p>
        Press <kbd ot-enable="responding" ot-input name="answer" value="Y" ot-kbd="y">Y</kbd> if the expression is correct,
        press <kbd ot-enable="responding" ot-input name="answer" value="N" ot-kbd="n">N</kbd> if it's not,
    </p>
    <p>Only answer when you see <code>?</code></p>
</footer>


{{ endblock }}

{{ block scripts }}

<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>

<script>
    "use strict";

    const SCHEDULE = js_vars.schedule;
    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade css

    ot.onStartPage(function () {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};

        ot.sendLive('next');
        // expecting live trial and progress, or termination
    });

    ot.onLive('progress', function (progress) {
        vars.progress = progress;
    });

    ot.onLive('trial', function (trial) {
        vars.trial = trial;

        vars.response = null;
        vars.feedback = null;
        vars.fading = "fadein";
        ot.hideDisplays();
        ot.resetInputs();
        ot.startPhases(SCHEDULE);
    });

    ot.onPhase('aim', function() {
        console.debug("aim");
        ot.switchDisplays({ only: 'aim' });
    });

    ot.onPhase('stimulus', function() {
        console.debug("stimulus");
        ot.switchDisplays({ only: 'stimulus' });
    });

    ot.onPhase('responding', function() {
        console.debug("response");
        ot.switchDisplays({ only: 'responding' });
        ot.enableInputs();
        ot.startTimeMeasurement();
    });

    ot.onPhase('timeout', function() {
        console.debug("timeout");
        ot.disableInputs();
        ot.sendLive('timeout', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
        });
    });

    ot.onInput('answer', function (answer) {
        ot.disableInputs();
        ot.cancelPhases();

        ot.sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            response: answer
        });
    });

    ot.onLive('feedback', function (feedback) {
        vars.feedback = feedback;
        vars.fading = "fadeout";
        ot.delay(FADEOUT_TIME, function () {
            ot.sendLive('next');
        });
    });

    ot.onLive('terminate', function () {
        ot.completePage();
    });

    ot.onLive('failure', function (message) {
        alert(message);
        ot.completePage();
    });

    /* adjust style when feedback changes */
    ot.onDelete('vars.feedback', function () {
        vars.feedback_style = null;
    });
    ot.onUpdate('vars.feedback', function (feedback) {
        vars.feedback_style = feedback.success ? "is-valid" : "is-invalid";
    });
</script>

{{ endblock }}