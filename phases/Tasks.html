{{ block content }}

<header>
    <my-progress max="vars.progress.total" ticks="1" value="vars.progress.completed"
        value2="vars.trial.iteration"></my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.fading">
    <div ot-display="aiming" class="icon">✛</div>
    <div ot-display="showing" class="fs-2">
        <span ot-text="vars.trial.expression"></span>
        =
        <span ot-text="vars.trial.suggestion"></span>
    </div>
    <div ot-display="responding" class="icon">?</div>
    <div ot-display="feedback-success" class="icon">✔</div>
    <div ot-display="feedback-failure" class="icon">✘</div>
    <div ot-display="feedback-timeout" class="icon">⌛</div>
</main>

<footer>
    <p>
        Press <kbd ot-enable="responding" ot-input name="response" value="Y" ot-kbd="y">Y</kbd> if the expression is
        correct,
        press <kbd ot-enable="responding" ot-input name="response" value="N" ot-kbd="n">N</kbd> if it's not,
    </p>
    <p>Only answer when you see <code>?</code></p>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'enhancements.css' }}">
<link rel="stylesheet" href="{{ static 'xfade.css' }}">
<link rel="stylesheet" href="{{ static 'progress2.css' }}">
<link rel="stylesheet" href="{{ static 'spinner-pulse.css' }}">
<style>
    .icon {
        font-size: xxx-large;
    }
</style>
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>
<script>
    "use strict";

    const SCHEDULE = js_vars.C.SCHEDULE;
    const TRIAL_DELAY = js_vars.C.TRIAL_DELAY;
    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade css

    ot.onStartPage(startGame);
    ot.onLive('progress', updateProgress);
    ot.onLive('trial', startTrial);
    ot.onPhase('aiming', switchAiming);
    ot.onPhase('showing', switchShowing);
    ot.onPhase('responding', switchResponding);
    ot.onPhase('timeout', inputTimeout);
    ot.onInput('response', inputResponse);
    ot.onLive('feedback', completeTrial);
    ot.onDelete('vars.feedback', displayFeedback);
    ot.onUpdate('vars.feedback', displayFeedback);
    ot.onUpdate('vars.timeout', displayFeedback);
    ot.onLive('failure', function (message) { alert(message); ot.completePage(); });


    function startGame() {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};
        vars.fading = "hidden";
        nextIter();
    };

    function updateProgress(progress) {
        if (vars.progress.terminated === undefined && progress.terminated) ot.completePage(); // occasionally reloaded alreay completed page
        vars.progress = progress;
    };

    function nextIter() {
        if (vars.progress.terminated) {
            ot.completePage();
        } else {
            ot.sendLive('iter'); // expecting live progress and trial
        }
    }

    function startTrial(trial) {
        vars.trial = trial;
        vars.response = null;
        vars.feedback = null;
        vars.timeout = false;

        ot.hideDisplays();
        ot.resetInputs();
        ot.startPhases(SCHEDULE);
        vars.fading = "fadein";
    };

    function switchAiming() {
        ot.switchDisplays({ only: 'aiming' });
    };

    function switchShowing() {
        ot.switchDisplays({ only: 'showing' });
    };

    function switchResponding() {
        ot.switchDisplays({ only: 'responding' });
        ot.enableInputs();
        ot.startTimeMeasurement();
    };

    function inputTimeout() {
        ot.disableInputs();
        ot.switchDisplays({ off: 'responding' });

        vars.timeout = true;

        ot.sendLive('timeout', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
        });
    };

    function inputResponse(value) {
        ot.disableInputs();
        ot.switchDisplays({ off: 'responding' });
        ot.cancelPhases();

        vars.response = value;

        ot.sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            response: vars.response,
        });
    };

    function completeTrial(feedback) {
        vars.feedback = feedback;

        ot.delay(TRIAL_DELAY - FADEOUT_TIME, function () {
            vars.fading = "fadeout";
        });
        ot.delay(TRIAL_DELAY, function () {
            nextIter();
        });
    };

    function displayFeedback() {
        if (vars.timeout) {
            ot.switchDisplays({ on: 'feedback-timeout' });
        } else if (vars.feedback !== null) {
            ot.switchDisplays({ on: vars.feedback.success ? 'feedback-success' : 'feedback-failure' });
        } else {
            ot.switchDisplays({ off: ['feedback-timeout', 'feedback-success', 'feedback-failure'] });
        }
    }

</script>
{{ endblock }}