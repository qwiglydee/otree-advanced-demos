{{ block content }}

<header>
    <h4>Votes:</h4>
    <ul class="w-25 list-group m-3">
        <li class="list-group-item"><span ot-text="vars.votes.0.player"></span>&nbsp;<b ot-text="vars.votes.0.choice"></b></li>
        <li class="list-group-item"><span ot-text="vars.votes.1.player"></span>&nbsp;<b ot-text="vars.votes.1.choice"></b></li>
        <li class="list-group-item"><span ot-text="vars.votes.2.player"></span>&nbsp;<b ot-text="vars.votes.2.choice"></b></li>
    </ul>
</header>

<main>
    <div class="w-100 chat rounded border pt-2">
        <div class="message mx-2" ot-html="vars.chat.0"></div>
        <div class="message mx-2" ot-html="vars.chat.1"></div>
        <div class="message mx-2" ot-html="vars.chat.2"></div>
        <div class="message mx-2" ot-html="vars.chat.3"></div>
        <div class="message mx-2" ot-html="vars.chat.4"></div>
        <div class="message mx-2" ot-html="vars.chat.5"></div>
        <div class="message mx-2" ot-html="vars.chat.6"></div>
        <div class="message mx-2" ot-html="vars.chat.7"></div>
        <div class="message mx-2" ot-html="vars.chat.8"></div>
        <div class="message mx-2" ot-html="vars.chat.9"></div>

        <input ot-input type="text" name="message" ot-key-input="Enter" class="form-control bg-light border-0" placeholder="type a message to send to chat">
    </div>
</main>

<footer>
    <div class="form-group">
        <label class="form-label">Your vote:</label>
        <select ot-input name="vote" class="form-select d-inline bg-light">
            <option></option>
            {{ for i, option in options }}
            <option>{{option}}</option>
            {{ endfor }}
        </select>
    </div>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<style>
    input.form-control {
        max-width: none;
    }

    .message {
        height: 2em;
    }
</style>
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b2.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script>
    const CHAT_SIZE = 10;

    ot.onEvent('loaded', initPage);
    ot.onEvent('input', 'vote', onInput(sendVote));
    ot.onEvent('input', 'message', onInput(sendChat));
    ot.onEvent('live', 'votes', onLive(liveVotes));
    ot.onEvent('live', 'chat', onLive(liveChat));
    ot.onEvent('live', 'failure', onLive(function (message) { alert(message); ot.completePage(); }));

    function initPage() {
        vars.votes = [];
        vars.chat = [];
        sendLive('load');
    };

    function sendVote(name, value) {
        sendLive('vote', value);
    };

    function liveVotes(name, data) {
        console.debug("live", name, data);
        vars.votes = data.votes;
        if (data.consensus) completePage();
    }

    function sendChat(name, text) {
        sendLive('chat', text);
        ot.resetInput("message");
    };

    function liveChat(name, data) {
        console.debug("live", name, data);
        if (data.text) displayChat(`Player ${data.player}`, data.text);
        if (data.vote) displayChat(`* Player ${data.player} votes`, data.vote);
    };

    function displayChat(player, msg) {
        vars.chat.push(`<b>${player}</b> ${msg}`);
        vars.chat = vars.chat.splice(-CHAT_SIZE);
    }

    async function completePage() {
        await ot.delay(1000);
        ot.completePage();
    }

</script>
{{ endblock }}