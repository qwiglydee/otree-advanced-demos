{{ block title }}
Task
{{ endblock }}

{{ block content }}

<header>
    <div my-progress="progress.*"></div>
</header>

<main ot-class="hiding">
    <div class="fs-1" ot-text="trial.question"></div>

    <div class="input-group">
        <input type="number" class="form-control" ot-class="validation_style" ot-input="answer" autofocus>
    </div>
</main>

<footer>
    <div>Type solution to the equation and press <kbd>Enter</kbd></div>
</footer>

<!-- form fields to submit to server -->
<input type="hidden" name="answers" ot-attr-value="form.answers">
<input type="hidden" name="total_time" ot-attr-value="form.total_time">

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'progress2.css' }}">
<link rel="stylesheet" href="{{ static 'common.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-1.1.1.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>

<script>
    "use strict";

    const TRIALS = js_vars.trials;
    const NUM_TRIALS = js_vars.num_trials;
    const TRIAL_DELAY = js_vars.trial_delay;

    ot.onLoad(function () {
        ot.page.form = { answers: "", total_time: 0 }
        ot.page.progress = { total: NUM_TRIALS, current: 0, completed: 0, ticks: 1 };

        ot.freezeInputs();
        ot.startIteration();
        ot.beginMeasurement('total');
    });

    ot.onIteration(function () {
        delete ot.page.trial;
        delete ot.page.response;

        if (ot.page.progress.current == NUM_TRIALS) {
            ot.page.form.total_time = ot.endMeasurement('total') / 1000;
            ot.completePage();
            return;
        }

        ot.page.progress.current += 1;
        ot.startTrial(TRIALS[ot.page.progress.current]);
    });

    ot.onTrial(function (trial) {
        console.debug("trial", trial);
        ot.page.trial = trial;
        delete ot.page.hiding;
        ot.resetInputs();
    });

    ot.onInput('answer', function (value) {
        console.debug("answer", value);
        ot.page.response = validateInput(value);
        if (ot.page.response == undefined) return;

        ot.freezeInputs();
        ot.completeTrial({ status: "ok" });
    });

    function validateInput(val) {
        let num = parseInt(val);
        return Number.isNaN(num) ? undefined : num;
    }

    ot.onComplete(function (results) {
        ot.page.progress.completed += 1;
        ot.page.form.answers += ot.page.response + ";";

        ot.delayEvent(TRIAL_DELAY - 200, "fadeout");
        ot.delayEvent(TRIAL_DELAY, 'startIteration');
    });

    ot.onEvent('fadeout', function () {
        ot.page.hiding = "hiding";
    });
</script>

{{ endblock }}