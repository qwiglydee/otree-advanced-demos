{{ block content }}

<header>
    <ot-progress max="vars.progress.total" ticks="1" val="vars.progress.solved"></ot-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main>
    {{ for id in sliders }}
    <ot-slider name="slider-{{id}}" min="-{{C.SLIDER_RANGE}}" max="{{C.SLIDER_RANGE}}"
        offset="vars.sliders.{{id}}.offset" solved="vars.sliders.{{id}}.solved"></ot-slider>
    {{ endfor }}
</main>

<footer>
    <p>Put all sliders into their middle position.</p>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
<link rel="stylesheet" href="{{ static 'ot-slider.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b1.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'ot-slider.js' }}"></script>
<script>
    "use strict";

    ot.onEvent('loaded', startPage);
    ot.onEvent('live', 'sliders', onLive(liveSliders));
    ot.onEvent('live', 'progress', onLive(liveProgress));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'failure', onLive(function (message) { alert(message); ot.submitPage(); }));
    ot.onEvent('input', (e) => e.detail.name.startsWith('slider-'), onInput(inputSlider));

    function startPage() {
        vars.sliders = {};  // map of { id: properties }
        ot.disableInputs();
        sendLive('reset');
        // expecting reply 'progress', 'sliders'
    };

    async function liveProgress(name, data) {
        vars.progress = data;
        if (vars.progress.terminated) {
            await ot.delay(1000);
            ot.submitPage();
        }
    };

    function liveSliders(name, data) {
        vars.sliders = data;
        for (let id in data) ot.resetInput(`slider-${id}`, data[id].value);
        ot.enableInputs();
    };

    function inputSlider(name, data) {
        let { id, value } = data;
        sendLive("slider", { id, value });
    };

    function liveFeedback(name, data) {
        console.debug(name, data);
        vars.sliders[data['id']].solved = data['solved'];
    };
</script>
{{ endblock }}