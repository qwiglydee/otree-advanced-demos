{{ block content }}

<header>
    <ot-progress ticks="1" max="vars.progress.total" val="vars.progress.played" val2="vars.trial.iteration">
    </ot-progress>
    <div class="alert alert-secondary m-2">Total score: <b ot-text="vars.progress.score"></b></div>
    <p id="feedback-gain">You <i ot-text="vars.gain_txt"></i></p>
</header>

<main ot-fade>
    <div class="fs-1 m-3" ot-text="vars.trial.expression"></div>

    <section class="bg-light border border-rounded m-3 p-3 d-flex flex-row gap-3">
        <button ot-click-input id="decision-1" type="button" class="btn" ot-class="vars.styles.decisions.ANSWER"
            name="decision" value="ANSWER">Answer</button>
        <button ot-click-input id="decision-2" type="button" class="btn" ot-class="vars.styles.decisions.REDUCE"
            name="decision" value="REDUCE">50:50</button>
        <button ot-click-input id="decision-3" type="button" class="btn" ot-class="vars.styles.decisions.SKIP"
            name="decision" value="SKIP">Skip</button>
    </section>

    <section class="bg-light border border-rounded m-3 p-3 d-flex flex-row gap-3">
        <button ot-click-input id="choice-1" type="button" class="btn" ot-class="vars.styles.choices.1" name="answer"
            value="1" ot-text="vars.trial.options.1"></button>
        <button ot-click-input id="choice-2" type="button" class="btn" ot-class="vars.styles.choices.2" name="answer"
            value="2" ot-text="vars.trial.options.2"></button>
        <button ot-click-input id="choice-3" type="button" class="btn" ot-class="vars.styles.choices.3" name="answer"
            value="3" ot-text="vars.trial.options.3"></button>
        <button ot-click-input id="choice-4" type="button" class="btn" ot-class="vars.styles.choices.4" name="answer"
            value="4" ot-text="vars.trial.options.4"></button>
    </section>

</main>

<footer>
    <p id="guidance-prompt-1">Decide your strategy.</p>
    <p id="guidance-prompt-2">Click on a button with your solution.</p>
    <ot-pulse id="guidance-wait"></ot-pulse>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'otree-front-ext.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b1.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.C.FEEDBACK_DELAY;
    const FADEOUT_TIME = parseInt(getStyleProp("--ot-fade-out-time"));

    ot.onEvent('loaded', startGame);
    ot.onEvent('live', 'progress', onLive(liveProgress));
    ot.onEvent('live', 'trial', onLive(startTrial));
    ot.onEvent('input', 'decision', onInput(inputDecision));
    ot.onEvent('input', 'answer', onInput(inputAnswer));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'options', onLive(liveOptions));
    ot.onEvent('live', 'failure', onLive(function (_, message) { alert(message); ot.submitPage(); }));

    function startGame() {
        ot.disableInputs();
        vars.progress = {};
        nextIter();
        // expecting live trial and progress...
    };

    function liveProgress(name, data) {
        vars.progress = data;
        if (vars.progress.terminated) completeGame();
    };

    async function completeGame() {
        await ot.delay(FEEDBACK_DELAY); // wait for remaining delays from feedback
        ot.submitPage();
    }

    function nextIter() {
        resetTrial();
        ot.switchDisplays("guidance-wait");
        sendLive('iter');
        // expecting live trial and progress...
    }

    function resetTrial() {
        vars.trial = null;
        vars.decision = null;
        vars.choice = null;
        vars.answer = null;
        vars.feedback = null;
        vars.styles = { choices: {}, decisions: {} };
        clearChoice();
        clearDecision();
        clearFeedback();
        ot.resetInputs();
    }

    function startTrial(name, data) {
        vars.trial = data;
        vars.options = "1234";
        fadeIn();
        ot.switchDisplays("guidance-prompt-1");
        ot.enableInputs(["decision-1", "decision-2", "decision-3"]);
        ot.disableInputs(["choice-1", "choice-2", "choice-3", "choice-4"]);
        ot.beginTimeMeasurement("decision");
        ot.beginTimeMeasurement("choice");
    }

    function inputDecision(name, value) {
        ot.switchInputs("decision-none");
        ot.switchDisplays("guidance-wait");

        vars.decision = value;

        highlightDecision();

        sendLive('decision', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement("decision"),
            decision: vars.decision
        });
        // expecting live feedback or reduce and progress...
    }


    function inputAnswer(name, value) {
        ot.switchInputs("choice-none");
        ot.switchDisplays("guidance-wait");

        vars.choice = Number(value);
        vars.answer = vars.trial.options[value];

        highlightChoice();

        sendLive('answer', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement("choice"),
            answer: vars.answer
        });
        // expecting live feedback and progress...
    };

    async function liveFeedback(name, data) {
        vars.feedback = data;

        displayFeedback();
        await ot.delay(FEEDBACK_DELAY);
        clearFeedback();

        fadeOut();
        await ot.delay(FADEOUT_TIME);

        nextIter();
    };

    function liveOptions(name, data) {
        vars.options = data.options;
        ot.switchInputs(Array.from(vars.options).map(i => `choice-${i}`));
        ot.switchDisplays("guidance-prompt-2");
    }

    function clearFeedback() {
        ot.switchDisplays('feedback-none');
        vars.gain_txt = null;
    }

    function displayFeedback() {
        ot.showDisplays('feedback-gain');
        vars.gain_txt = format_gain(vars.feedback.score);
        vars.styles.choices[vars.choice] = vars.feedback.success ? ["selected", "btn-success"] : ["selected", "btn-danger"];
    }

    function clearDecision() {
        vars.styles.decisions = {
            'ANSWER': "btn-primary",
            'REDUCE': "btn-primary",
            'SKIP': "btn-primary",
        }
    }

    function highlightDecision() {
        vars.styles.decisions = {
            'ANSWER': "btn-outline-dark",
            'REDUCE': "btn-outline-dark",
            'SKIP': "btn-outline-dark",
        }
        vars.styles.decisions[vars.decision] = ["selected", "btn-dark"];
    }

    function clearChoice() {
        vars.styles.choices = {
            1: "btn-primary",
            2: "btn-primary",
            3: "btn-primary",
            4: "btn-primary",
        }
    }

    function highlightChoice() {
        vars.styles.choices = {
            1: "btn-outline-dark",
            2: "btn-outline-dark",
            3: "btn-outline-dark",
            4: "btn-outline-dark",
        }
        vars.styles.choices[vars.choice] = ["selected", "btn-dark"];
    }

</script>
{{ endblock }}