/*!
otree-front v2.0.b
Microframework for interactive pages for oTree platform
(C) qwiglydee@gmail.com
https://github.com/oTree-org/otree-front
*/
var ot=function(t){"use strict";function e(t){return Array.isArray(t)}function i(t){return"function"==typeof t}function n(t){return null==t||Number.isNaN(t)}function s(t){var e=typeof t;return"string"===e||("number"===e||("boolean"===e||("symbol"===e||(null==t||(t instanceof Symbol||(t instanceof String||(t instanceof Number||t instanceof Boolean)))))))}function r(t){return"[object Object]"===Object.prototype.toString.call(t)}function a(t){var e,i;return!1!==r(t)&&(void 0===(e=t.constructor)||!1!==r(i=e.prototype)&&!1!==i.hasOwnProperty("isPrototypeOf"))}function o(t,n){return Array.from(t).every(((t,s)=>function(t,n){switch(n){case"any":return!0;case"array":return e(t);case"object":return r(t);case"class":return i(t);default:return typeof t===n}}(t,n[s])))}function u(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];if(0==n.filter((t=>t.length==e.length&&o(e,t))).length){const e=n.map((e=>"".concat(t,"(").concat(e.join(", "),")"))).join(" or ");throw new Error("Invalid arguments, expected: ".concat(e))}}function*c(t){let e=t.split(".");for(let t=0;t<e.length-1;t++)yield[e.slice(0,t+1).join("."),e.slice(t+1).join(".")]}function l(t){return s(t)||r(t)||e(t)||t instanceof HTMLElement}function h(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return function*(){if(""!=i&&l(t)&&(yield[i,n(t)?null:t]),a(s=t)||e(s))for(let[e,n]of Object.entries(t))l(n)&&(yield*h(n,i?"".concat(i,".").concat(e):e));var s}()}class m extends Map{affect(t){let e=t.endsWith(".*"),i=e?t.slice(0,-2):t;if(this.has(i))return!0;for(let[t,e]of c(i))if(this.has(t))return!0;if(e){let t=i+".";for(let e of this.keys())if(e.startsWith(t))return!0}return!1}extract(t){let e=t.endsWith(".*")?t.slice(0,-2):t;if(this.has(e))return this.get(e);for(let[t,s]of c(e))if(this.has(t))return i=this.get(t),"string"==typeof(n=s)&&(n=n.split(".")),n.reduce(((t,e)=>t&&e in t?t[e]:void 0),i);var i,n}}function d(t,e){let i=new Set([].concat(Array.from(t.keys()),Array.from(e.keys()))),n=Array.from(i).filter((i=>t.get(i)!==e.get(i)));return n=n.filter((t=>{return!(e=t,Array.from(c(e)).map((t=>t[0]))).some((t=>n.includes(t)));var e})),new m(n.map((t=>[t,e.has(t)?e.get(t):null])))}function p(){let t=(e=window.vars,new Map(h(e)));var e;let i=d(window.ot_snapshot,t);i.size&&(window.ot_snapshot=t,document.body.dispatchEvent(new CustomEvent("ot.update",{detail:{changes:i}})))}function f(t,e){u("emitEvent",arguments,["string"],["string","object"]),setTimeout((()=>document.body.dispatchEvent(new CustomEvent("ot.".concat(t),{detail:e}))))}function v(t,e){u("triggerEvent",arguments,["string"],["string","object"]),document.body.dispatchEvent(new CustomEvent("ot.".concat(t),{detail:e}))}function g(t){v("submitted"),t.preventDefault(),document.getElementById("form").checkValidity()&&setTimeout((()=>{HTMLFormElement.prototype.submit.call(document.getElementById("form"))}))}function y(){f("reset")}function w(t){return t.map((t=>"#".concat(t))).join(",")}const E="input,[input],select,textarea";function b(){let t=document.querySelector("[autofocus]:enabled:not([hidden]):not([hidden] *)");t&&t.focus()}class A{constructor(t){this.name=t,this.started=0,this.counter=0,this.handler=null}start(){this.started=Date.now(),this.counter=0,window.ot_timers[this.name]=this}elapsed(){return Date.now()-this.started}cancel(){window.clearTimeout(this.handler),delete window.ot_timers[this.name]}}class x extends A{constructor(t,e){super(t),this.timeout=e}start(){super.start(),this.handler=window.setTimeout((()=>{v("timer",{name:this.name,elapsed:this.elapsed(),count:1})}),this.timeout)}}class I extends A{constructor(t,e,i){super(t),this.period=e,this.count=i}start(){super.start(),this.handler=window.setTimeout((()=>{v("timer",{name:this.name,elapsed:this.elapsed(),count:0}),this.restart()}),0)}restart(){this.handler=window.setInterval((()=>{this.counter+=1,v("timer",{name:this.name,elapsed:this.elapsed(),count:this.counter}),this.count&&this.counter>=this.count&&this.cancel()}),this.period)}}class T extends A{constructor(t,e){super(t),this.intervals=e}start(){super.start(),this.handler=window.setTimeout((()=>{v("timer",{name:this.name,elapsed:this.elapsed(),count:0}),this.restart()}),0)}restart(){this.handler=window.setTimeout((()=>{this.counter+=1,v("timer",{name:this.name,elapsed:this.elapsed(),count:this.counter}),this.counter>=this.intervals.length?this.cancel():this.restart()}),this.intervals[this.counter])}}function k(){window.ot_timers={}}function P(t){u("cancelTimer",arguments,["string"]),t in window.ot_timers&&window.ot_timers[t].cancel()}function S(t){return u("preloadImage",arguments,["string"]),new Promise(((e,i)=>{let n=new Image;n.loading="eager",n.src=t,n.onload=()=>e(n)}))}function j(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class C{constructor(t){j(this,"params",{}),this.elem=t,this.isField=["INPUT","TEXTAREA","SELECT"].includes(this.elem.nodeName),this.isNavigable=-1!=this.elem.tabIndex}get hidden(){return this.elem.hasAttribute("hidden")||null!=this.elem.closest("[hidden]")}get disabled(){return this.elem.hasAttribute("disabled")}get focused(){return this.elem===document.activeElement}get active(){return!this.hidden&&!this.disabled}get value(){if(this.input)return this.input.value}set value(t){this.input&&(this.input.value=t)}init(){}render(){}update(t){this.render()}commit(t){void 0===t&&(t=this.value),this.triggerPageEvent("input",{name:this.name,value:t})}initParams(){if("value"in this.params)throw new Error("Value is a special property and should not be configured via params.");this.paramVars={};for(let t in this.params){let e=this.params[t],i=this.elem.getAttribute(e.attr||t);null===i?this[t]=e.default:i.startsWith("vars.")?(this.paramVars[t]=i.slice(5),this[t]=e.default):this[t]=i}}initValue(){n(this.input.value)||""==this.input.value?this.input.hasAttribute("value")?(this.elem.ot.initialValue=this.input.getAttribute("value"),this.value=this.elem.ot.initialValue):this.valueDefault&&(this.elem.ot.initialValue=this.valueDefault,this.value=this.elem.ot.initialValue):this.elem.ot.initialValue=this.input.value}updateParams(t){let e=Object.entries(this.paramVars).filter((e=>{let[i,n]=e;return t.affect(n)}));return e.forEach((e=>{let[i,n]=e;return this[i]=t.extract(n)})),new Set(e.map((t=>{let[e,i]=t;return e})))}onEvent(t,e,i){t.addEventListener(e,(t=>{try{i.call(this,t)}catch(e){console.error(e),console.error("Failed to handle '".concat(t.type,"' for ").concat(this.constructor.name," at"),this.elem)}}))}onPageEvent(t,e){this.onEvent(document.body,"ot.".concat(t),e)}onElemEvent(t,e){this.onEvent(this.elem,t,e)}triggerElemEvent(t){let e=new Event(t);this.elem.dispatchEvent(e)}triggerPageEvent(t,e){let i=new CustomEvent("ot.".concat(t),{detail:e});i.source=this.elem,document.body.dispatchEvent(i)}}class D extends C{init(){this.initParams(),this.render(),this.onPageEvent("update",this.onUpdate)}onUpdate(t){let e=t.detail.changes,i=this.updateParams(e);i.size&&this.update(i)}}class M extends C{init(){if(!this.isField)throw new Error("The input directive is for native input elements only");if(!this.elem.hasAttribute("name"))throw Error("Input element misses `name` attribute");this.name=this.elem.getAttribute("name"),this.elem.setAttribute("input",this.name),this.input=this.elem,this.initParams(),this.initValue(),this.onElemEvent("change",this.onChange),this.onElemEvent("reset",this.onReset),this.onPageEvent("reset",this.onPageReset)}onChange(){this.active&&(this.update(new Set(["value"])),this.commit())}onReset(){this.update(new Set(["value"]))}onPageReset(){this.value=this.elem.ot.initialValue,this.update(new Set(["value"]))}}class V extends C{init(){if(this.isInput=this.isField||this.elem.hasAttribute("input"),this.input=this.elem,this.initParams(),!this.isInput){if(!this.elem.hasAttribute("name"))throw Error("Input element misses `name` attribute");this.name=this.elem.getAttribute("name"),this.elem.setAttribute("input",this.name),this.initValue()}}trigger(){this.active&&(this.isInput?this.triggerElemEvent("change"):this.triggerPageEvent("input",{name:this.name,value:this.value}))}}function L(t,e){u("attachDirective",arguments,["class","string"]),document.querySelectorAll(e).forEach((e=>{void 0===e.ot&&(e.ot={});try{let i=new t(e);i.init(),e.ot[t.name]=i}catch(i){console.error(i),console.error("Failed to create directive ".concat(t.name," at"),e)}}))}class q extends D{constructor(){super(...arguments),j(this,"params",{val:{attr:"ot-text"}})}render(){n(this.val)?this.elem.textContent="":this.elem.textContent=this.val}}class O extends D{constructor(){super(...arguments),j(this,"params",{val:{attr:"ot-html"}})}render(){n(this.val)?this.elem.innerHTML="":this.elem.innerHTML=this.val}}class _ extends D{constructor(){super(...arguments),j(this,"attr","foo"),j(this,"params",{val:{attr:"ot-foo"}})}render(){n(this.val)?this.elem.removeAttribute(this.attr):this.elem.setAttribute(this.attr,this.val)}}class N extends _{constructor(){super(...arguments),j(this,"attr","min"),j(this,"params",{val:{attr:"ot-min"}})}}class R extends _{constructor(){super(...arguments),j(this,"attr","max"),j(this,"params",{val:{attr:"ot-max"}})}}class B extends _{constructor(){super(...arguments),j(this,"attr","step"),j(this,"params",{val:{attr:"ot-step"}})}}class F extends _{constructor(){super(...arguments),j(this,"attr","width"),j(this,"params",{val:{attr:"ot-width"}})}}class H extends _{constructor(){super(...arguments),j(this,"attr","height"),j(this,"params",{val:{attr:"ot-height"}})}}class W extends _{constructor(){super(...arguments),j(this,"attr","href"),j(this,"params",{val:{attr:"ot-href"}})}}class K extends _{constructor(){super(...arguments),j(this,"attr","src"),j(this,"params",{val:{attr:"ot-src"}})}}class U extends D{constructor(){super(...arguments),j(this,"params",{val:{attr:"ot-class"}})}init(){this.initial=Array.from(this.elem.classList),super.init()}render(){let t=this.initial.slice();n(this.val)||(Array.isArray(this.val)?t=t.concat(this.val):t.push(this.val)),this.elem.classList.remove(...this.elem.classList),this.elem.classList.add(...t)}}class z extends D{constructor(){super(...arguments),j(this,"params",{val:{attr:"ot-value"}})}render(){n(this.val)?this.elem.value=null:this.elem.value=this.val,this.triggerElemEvent("reset")}}class X extends M{}class Y extends M{constructor(){super(...arguments),j(this,"params",{autocommit:{default:null}})}init(){super.init(),this.onElemEvent("keypress",this.onKey),""==this.autocommit&&(this.autocommit=350),this.autocommit&&this.onElemEvent("input",this.onAutocommit)}commit(){"number"==this.elem.type?super.commit(Number(this.value)):super.commit()}onKey(t){"Enter"===t.key&&t.preventDefault()}onAutocommit(){this.commit_timeout&&window.clearTimeout(this.commit_timeout),this.commit_timeout=window.setTimeout((()=>this.commit()),this.autocommit)}}class Z extends M{commit(){super.commit(Number(this.value))}}class G extends M{commit(){this.elem.checked&&super.commit()}}class J extends M{commit(){"on"==this.elem.value?super.commit(this.elem.checked):super.commit(this.elem.checked?this.value:null)}}class Q extends V{init(){super.init(),this.onElemEvent("click",this.onClick)}onClick(){this.active&&this.trigger()}}class $ extends V{constructor(){super(...arguments),j(this,"params",{key:{attr:"ot-key-input"}})}init(){if(super.init(),1!=this.key.length&&!this.key.match(/[A-Z]\w+/))throw new Error('Invalid key name: "'.concat(this.key,'", expected a letter or a codename.'));this.onEvent(document.body,"keypress",this.onKey)}onKey(t){!this.active||this.key!=t.key&&this.key!=t.code||(t.preventDefault(),t.stopImmediatePropagation(),this.trigger())}}class tt extends C{init(){super.init(),this.name=this.elem.getAttribute("name"),this.onElemEvent("click",this.onClick)}onClick(t){this.active&&this.commit({x:t.offsetX,y:t.offsetY})}}function et(t,e){void 0===e&&(e=t.ot.initialValue),t.value=e,t.dispatchEvent(new Event("reset"))}return window.addEventListener("DOMContentLoaded",(()=>{L(q,"[ot-text]"),L(O,"[ot-html]"),L(N,"[ot-min]"),L(R,"[ot-max]"),L(B,"[ot-step]"),L(F,"[ot-width]"),L(H,"[ot-height]"),L(K,"[ot-src]"),L(W,"[ot-href]"),L(U,"[ot-class]"),L(z,"[ot-value]"),L(Y,"input[ot-input]:is([type=text],[type=number])"),L(Y,"textarea[ot-input]"),L(Z,"input[ot-input][type=range]"),L(G,"input[ot-input][type=radio]"),L(J,"input[ot-input][type=checkbox]"),L(X,"input[ot-input]:not([type=text],[type=number],[type=range],[type=radio],[type=checkbox])"),L(X,"select[ot-input]"),L($,"[ot-key-input]"),L(Q,"[ot-click-input]"),L(tt,"[ot-point-input]"),window.vars={},window.ot_snapshot=new Map,document.getElementById("form").addEventListener("submit",g),document.getElementById("form").addEventListener("reset",y),k()})),window.addEventListener("load",(()=>{v("loaded")})),t.ContentDirective=D,t.DirectiveBase=C,t.NativeInput=M,t.TriggerInput=V,t.WidgetDirective=class extends C{init(){if(this.elem.hasAttribute("input"))this.name=this.elem.getAttribute("input"),this.input=document.querySelector("[name=".concat(this.name,"]"));else{if(!this.elem.hasAttribute("name"))throw Error("Input widget misses `name` or `input` attribute");this.name=this.elem.getAttribute("name"),this.input=this.elem,this.elem.setAttribute("input",this.name)}this.initParams(),this.initValue(),this.onPageEvent("update",this.onUpdate),this.onElemEvent("change",this.onChange),this.onElemEvent("reset",this.onReset),this.onPageEvent("reset",this.onPageReset),this.render()}onUpdate(t){let e=t.detail.changes,i=this.updateParams(e);i.size&&this.update(i)}onChange(){this.active&&this.commit()}onReset(){this.input!=this.elem&&(this.value=this.elem.value),this.update(new Set(["value"]))}onPageReset(){this.value=this.elem.ot.initialValue,this.update(new Set(["value"]))}},t.attachDirective=L,t.beginTimeMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"measurement";u("beginTimeMeasurement",arguments,[],["string"]),function(t){window.performance.clearMarks("ot.".concat(t,".begin")),window.performance.clearMarks("ot.".concat(t)),window.performance.clearMeasures("ot.".concat(t,".measure"))}(t),function(t){window.performance.mark("ot.".concat(t,".begin"))}(t)},t.cancelTimer=P,t.cancelTimers=function(t){u("cancelTimers",arguments,[],["string"],["array"]),void 0===t&&(t=Array.from(Object.keys(window.ot_timers))),e(t)||(t=[t]);for(let e of t)P(e)},t.commitInput=function(t){u("commitInput",arguments,["string"]),document.querySelectorAll("[input=".concat(t,"]")).forEach((t=>{t.dispatchEvent(new Event("change"))}))},t.delay=async function(t){return p(),new Promise(((e,i)=>{window.setTimeout((()=>e()),t)}))},t.delayEvent=function(t,e,i){u("delayEvent",arguments,["number","string"],["number","string","object"]),setTimeout((()=>document.body.dispatchEvent(new CustomEvent("ot.".concat(e),{detail:i}))),t)},t.disableInputs=function(t){u("disableInputs",arguments,[],["string"],["array"]),void 0===t?t="*":e(t)||(t=[t]);let i="*"==t?E:w(t);document.querySelectorAll(i).forEach((t=>t.setAttribute("disabled",""))),b()},t.emitEvent=f,t.enableInputs=function(t){u("enableInputs",arguments,[],["string"],["array"]),void 0===t?t="*":e(t)||(t=[t]);let i="*"==t?E:w(t);document.querySelectorAll(i).forEach((t=>t.removeAttribute("disabled"))),b()},t.getTimeMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"measurement";return u("getTimeMeasurement",arguments,[],["string"]),function(t){window.performance.mark("ot.".concat(t))}(t),Math.round(function(t){return window.performance.measure("ot.".concat(t,".measure"),"ot.".concat(t,".begin"),"ot.".concat(t))}(t).duration)},t.hideDisplays=function(t){u("hideDisplays",arguments,["string"],["array"]),e(t)||(t=[t]);let i=w(t);document.querySelectorAll(i).forEach((t=>t.hidden=!0))},t.initTimers=k,t.isArray=e,t.isFunction=i,t.isObject=r,t.isPlainObject=a,t.isScalar=s,t.isVoid=n,t.onEvent=function(t,e,i){u("onEvent",arguments,["string","function"],["string","string","function"],["string","function","function"]),2==arguments.length?(i=arguments[1],e=null):"string"==typeof arguments[1]&&(e=t=>t.detail&&t.detail.name==arguments[1]),document.body.addEventListener("ot.".concat(t),(async n=>{e&&!e(n)||(await i.call(null,n),"update"!==t&&p())}))},t.otCheckInput=J,t.otClass=U,t.otClick=Q,t.otHTML=O,t.otHeight=H,t.otHref=W,t.otInput=X,t.otKey=$,t.otMax=R,t.otMin=N,t.otPoint=tt,t.otRadioInput=G,t.otRangeInput=Z,t.otSrc=K,t.otStep=B,t.otText=q,t.otTextInput=Y,t.otValue=z,t.otWidth=F,t.preloadImage=S,t.preloadImages=function(t){return u("preloadImage",arguments,["array"]),Promise.all(t.map((t=>S(t))))},t.resetInput=function(t,e){u("resetInput",arguments,["string"],["string","any"]),document.querySelectorAll("[input=".concat(t,"]")).forEach((t=>et(t,e)))},t.resetInputs=function(){u("resetInputs",arguments,[]),document.querySelectorAll("[input]").forEach((t=>et(t)))},t.resetPage=function(){HTMLFormElement.prototype.reset.call(document.getElementById("form"))},t.showDisplays=function(t){u("showDisplays",arguments,["string"],["array"]),e(t)||(t=[t]);let i=w(t);document.querySelectorAll(i).forEach((t=>t.hidden=!1)),b()},t.startTimer=function(t,e){u("startTimer",arguments,["string","number"]),P(t),new x(t,e).start()},t.startTimerPeriodic=function(t,e,i){u("startTimerPeriodic",arguments,["string","number","number"],["string","number"]),P(t),new I(t,e,i).start()},t.startTimerSequence=function(t,e){u("startTimerSequence",arguments,["string","array"]),P(t),new T(t,e).start()},t.submitPage=function(){document.getElementById("form").requestSubmit()},t.switchDisplays=function(t){if(u("switchDisplays",arguments,["string"],["array"]),e(t)||(t=[t]),t.some((t=>!t.includes("-"))))throw new Error("switchDisplays only works on ids in form `group-item`");let i=t[0].split("-")[0],n=w(t),s="[id^=".concat(i,"-]:not(").concat(n,")");document.querySelectorAll(s).forEach((t=>t.hidden=!0)),document.querySelectorAll(n).forEach((t=>t.hidden=!1)),b()},t.switchInputs=function(t){u("switchInputs",arguments,["string"],["array"]),e(t)||(t=[t]);let i=t[0].includes("-")?t[0].split("-")[0]:"*",n=w(t),s="*"==i?E:"[id^=".concat(i,"-]");document.querySelectorAll(s).forEach((t=>t.setAttribute("disabled",""))),document.querySelectorAll(n).forEach((t=>t.removeAttribute("disabled"))),b()},t.triggerEvent=v,t.updatePage=p,t}({});Object.freeze(ot);
