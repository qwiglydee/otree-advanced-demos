/*!
otree-front v1.0.0
microframework for interactive pages for oTree platform
(C) qwiglydee@gmail.com
https://github.com/qwiglydee/otree-front
*/
var ot=function(t){"use strict";function e(t){return Array.isArray(t)}function n(t){return null==t||Number.isNaN(t)}function i(t){return Object.prototype.toString.call(t).startsWith("[object HTML")}function o(t){var e=typeof t;return"string"===e||("number"===e||("boolean"===e||("symbol"===e||(null==t||(t instanceof Symbol||(t instanceof String||(t instanceof Number||t instanceof Boolean)))))))}function s(t){return"[object Object]"===Object.prototype.toString.call(t)}function r(t){var e,n;return!1!==s(t)&&(void 0===(e=t.constructor)||!1!==s(n=e.prototype)&&!1!==n.hasOwnProperty("isPrototypeOf"))}function a(t,n){return Array.from(t).every(((t,i)=>function(t,n){switch(n){case"data":return!0;case"array":return e(t);case"object":return s(t);default:return typeof t===n}}(t,n[i])))}function c(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];let s=i.filter((t=>t.length==e.length&&a(e,t)));if(0==s.length){const e=i.map((e=>"".concat(t,"(").concat(e.join(", "),")"))).join(" or ");throw new Error("Invalid arguments, expected: ".concat(e))}}function l(t,e){c("emitEvent",arguments,["string","data"],["string"]);let n=new CustomEvent("ot.".concat(t),{detail:e});setTimeout((()=>document.body.dispatchEvent(n)))}function u(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const h=/^[a-zA-Z]\w+(\.\w+)*$/;function m(t,e){return e==t||e.startsWith(t+".")}function d(t,e){return m(t,e)||e.endsWith(".*")&&t.startsWith(e.slice(0,-2))}function f(t,e){return e.endsWith(".*")&&(e=e.slice(0,-2)),e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}var p=Object.freeze({__proto__:null,validate:function(t){return t.match(h)},length:function(t){return t.split(".").length},includes:m,affects:d,extract:f,update:function(t,e,n){const i=e.split("."),o=i.slice(0,-1),s=i.slice(-1)[0];let r=o.length?function(t,e){return e.reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}(t,o):t;if(void 0===r)throw new Error("Unreachable keypath ".concat(e));r[s]=n}});function v(t,e){return Array.from(t.keys()).some((t=>d(t,e)))}const g="([a-zA-Z]\\w+(\\.\\w+)*)";class b{static match(t){if(t.match(this.banned))throw new Error("banned expression");let e=t.match(this.regexp);if(!e)throw new Error("invalid expression");return e}affected(t){return v(t,this.var)}value(t){return f(t,this.var)}}u(b,"regexp",new RegExp("^"+g+"$")),u(b,"banned",new RegExp("^(true|false|null|undefined)$"));class E extends b{constructor(t){super();let e=this.constructor.match(t);this.name=e[1]}}u(E,"description","event name");class w extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1]}eval(t){return this.value(t)}}u(w,"description","variable");class y extends w{constructor(t){t.endsWith(".*")?(super(t.slice(0,-2)),this.nested=!0):(super(t),this.nested=!1)}affected(t){return this.nested?v(t,this.var+".*"):v(t,this.var)}}u(y,"description","variable watch");class x extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1],this.cmp=e[3],this.val=JSON.parse(e[4].replaceAll("'",'"')),!0!==this.val&&!1!==this.val&&null!==this.val||(this.cmp+="=")}eval(t){let e=this.value(t);if(null==e||Number.isNaN(e))return!1;switch(this.cmp){case"==":return e==this.val;case"!=":return e!=this.val;case"===":return e===this.val;case"!==":return e!==this.val}}}u(x,"description","comparision"),u(x,"regexp",new RegExp("^"+g+" (==|!=) (.+)$"));class T extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1],this.val=JSON.parse(e[3].replaceAll("'",'"'))}}function k(t,e){for(let n of e)try{return new n(t)}catch(t){continue}let n=e.map((t=>t.description)).join(" or ");throw new Error('Invalid expression: "'.concat(t,'", expected: ').concat(n))}function I(t){return o(t)||s(t)||e(t)||i(t)}function _(t){return r(t)||e(t)}function*S(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(""!=e&&I(t)&&(yield[e,n(t)?null:t]),_(t))for(let[n,i]of Object.entries(t))I(i)&&(yield*S(i,e?"".concat(e,".").concat(n):n))}function A(t){return new Map(S(t))}u(T,"description","assignment"),u(T,"regexp",new RegExp("^"+g+" = (.+)$"));let P=new Map;const j={update(){let t=A(this),e=function(t,e){let n=new Map,i=[],o=new Set;for(let e of t.keys())o.add(e);for(let t of e.keys())o.add(t);for(let s of o){if(i.some((t=>m(t,s))))continue;let o=t.get(s),r=e.get(s);r!==o&&(n.set(s,void 0===r?null:r),i.push(s))}return n}(P,t);0!=e.size&&(P=t,l("update",e))}};function L(t,e){c("onEvent",arguments,["string","function"]),document.body.addEventListener("ot.".concat(t),(async t=>{await e(t.detail,t),j.update()}))}function U(t){return 2==t.length?{match:t[0],handler:t[1]}:{match:void 0,handler:t[0]}}function C(t){c("startIteration",arguments,[]),l("startIteration",t)}const O=C;function z(t){return"otree.".concat(t,".beg")}function M(t){return"otree.".concat(t,".end")}function N(t){return"otree.".concat(t,".measure")}function R(t){performance.clearMarks(z(t)),performance.clearMarks(M(t)),performance.clearMeasures(N(t))}function W(t){performance.mark(z(t))}function F(t){performance.mark(M(t)),performance.measure(N(t),z(t),M(t))}function H(t){return performance.getEntriesByName(N(t))[0].duration}function B(t){return 2==t.length?{match:t[0],handler:t[1]}:{match:void 0,handler:t[0]}}class ${constructor(){this.timers={},this.schedule={},this.started=null}now(){return Math.floor(performance.now()-this.started)}start(t){this.stop(),this.schedule=t,this.started=performance.now();for(let e in t)this.startTimer(e)}startTimer(t){let e=this.schedule[t];this.timers[t]=window.setTimeout((()=>this.emitTimer(t)),e)}emitTimer(t){l("time",{time:this.now(),name:t,source:"timer"})}stop(){this.started=null;for(let t in this.timers)window.clearTimeout(this.timers[t]),delete this.timers[t]}cancel(t){window.clearTimeout(this.timers[t]),delete this.timers[t]}}const D=new $;const J=new class extends ${start(t){this.stop();for(let e in t)l("time",{time:0,name:e,source:"clock"});super.start(t)}emitTimer(t){l("time",{time:this.now(),name:t,source:"clock"}),super.startTimer(t)}};const K=new class extends ${start(t){this.stop();let e={},n=0;for(let i in t)e[i]=n,n+=t[i];super.start(e)}emitTimer(t){l("time",{time:this.now(),name:t,source:"schedule"})}};class q{constructor(t){this.elem=t;let e=Object.fromEntries(Array.from(this.elem.attributes).map((t=>[t.name,t.value])));try{this.init(e)}catch(t){console.error(t),console.error("Failed to initialize [".concat(this.constructor.otname,"] at"),this.elem)}}init(t){}onElemEvent(t,e){this.elem.addEventListener(t,function(n){try{e.call(this,n.detail,n)}catch(e){console.error(e),console.error("Failed to ".concat(t," [").concat(this.constructor.otname,"] at"),this.elem)}}.bind(this))}onPageEvent(t,e){document.body.addEventListener(t,function(n){try{e.call(this,n.detail,n)}catch(e){console.error(e),console.error("Failed to ".concat(t," [").concat(this.constructor.otname,"] at"),this.elem)}}.bind(this))}emitElemEvent(t){let e=new CustomEvent(t,{detail:arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,bubbles:arguments.length>2&&void 0!==arguments[2]&&arguments[2]});setTimeout((()=>this.elem.dispatchEvent(e)))}}u(q,"otname","ot-");class Z extends q{init(t){this.onPageEvent("ot.resetInputs",this.onReset),this.onPageEvent("ot.freezeInputs",this.onFreeze),this.onPageEvent("ot.submitInputs",this.onSubmit),this.onElemEvent("ot.submitInput",this.onSubmit),this.onElemEvent("ot.toggleInput",this.onToggle),this.elem.ot_frozen=!1,this.onToggle()}get input_name(){}get input_value(){}set input_value(t){}onReset(){this.input_value=null,this.elem.ot_frozen=!1,this.onToggle()}onFreeze(){this.elem.ot_frozen=!0,this.onToggle()}onToggle(){this.elem.disabled=this.elem.ot_disabled||this.elem.ot_frozen,this.elem.disabled?(this.elem.setAttribute("disabled",""),this.elem.blur()):this.elem.removeAttribute("disabled")}onSubmit(){this.elem.disabled||this.submit()}submit(){l("input",{name:this.input_name,value:this.input_value})}}class V extends q{init(t){this.var=k(t[this.constructor.otname],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(j);this.elem.textContent=null!=t?t:""}}}u(V,"otname","ot-text");class G extends q{init(t){this.var=k(t[this.constructor.otname],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(j);this.elem.innerHTML=null!=t?t:""}}}u(G,"otname","ot-html");class Q extends q{init(t){this.ref=k(t[this.constructor.otname],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.ref.affected(t)){let t=this.ref.eval(j);if(null==t)this.replace(new Image);else{if(!(t instanceof HTMLImageElement))throw new Error('Invalid content for "page.'.concat(this.ref.var,'", expected preloaded HTMLImage, use `ot.loadImage`'));this.replace(t)}}}replace(t){for(let e of this.elem.attributes)"src"!=e.name&&t.setAttribute(e.name,e.value);this.elem.replaceWith(t),this.elem=t}}u(Q,"otname","ot-img");class X extends q{init(t){this.var=k(t[this.constructor.otname],[w]),this.defaults=Array.from(this.elem.classList),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(j);this.elem.classList.remove(...this.elem.classList),this.elem.classList.add(...this.defaults),t&&this.elem.classList.add(t)}}}u(X,"otname","ot-class");class Y extends q{init(t){this.var=k(t[this.constructor.otname],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(j);null==t?this.elem.removeAttribute(this.constructor.attrname):this.elem.setAttribute(this.constructor.attrname,t)}}}u(Y,"otname","ot-attr"),u(Y,"attrname","");class tt extends Y{}u(tt,"otname","ot-attr-value"),u(tt,"attrname","value");class et extends Y{}u(et,"otname","ot-attr-min"),u(et,"attrname","min");class nt extends Y{}u(nt,"otname","ot-attr-max"),u(nt,"attrname","max");class it extends Y{}u(it,"otname","ot-attr-height"),u(it,"attrname","height");class ot extends Y{}u(ot,"otname","ot-attr-width"),u(ot,"attrname","width");class st extends q{init(t){this.cond=k(t[this.constructor.otname],[w,x]),this.onPageEvent("ot.update",this.onUpdate),this.toggle(!1)}onUpdate(t){if(this.cond.affected(t)){let t=this.cond.eval(j);this.cond instanceof w?this.toggle(!n(t)):this.toggle(t)}}toggle(t){this.elem.hidden=!t}}u(st,"otname","ot-if");class rt extends q{init(t){let e=t["ot-click"];if(void 0!==e&&""!==e)throw new Error('Invalid attribute value: "'.concat(e,'", expected: none'));this.onElemEvent("click",this.onClick)}onClick(){this.elem.disabled||this.emitElemEvent("ot.submitInput")}}u(rt,"otname","ot-click");class at extends rt{onClick(){this.elem.disabled||(this.emitElemEvent("ot.submitInput"),this.elem.blur())}}u(at,"otname","ot-button");class ct extends q{init(t){let e=t["ot-key"];if(""==e||!e.match(/[A-Z]\w+/))throw new Error('Invalid attribute value: "'.concat(e,'", see "Code values for keyboard" at developer.mozilla.org'));this.keycode=e,this.onPageEvent("keydown",this.onKey)}onKey(t,e){this.elem.disabled||e.code!=this.keycode||(e.preventDefault(),this.emitElemEvent("ot.submitInput"))}}u(ct,"otname","ot-key");class lt extends q{init(t){let e=k(t["ot-emit"],[E]);this.event_name=e.name,this.onElemEvent("ot.toggleInput",this.onToggle),this.onElemEvent("ot.submitInput",this.onSubmit)}onToggle(){this.elem.disabled=this.elem.ot_disabled,this.elem.disabled?this.elem.setAttribute("disabled",""):(this.elem.removeAttribute("disabled"),this.elem.blur())}onSubmit(){this.elem.disabled||l(this.event_name)}}u(lt,"otname","ot-emit");class ut extends Z{init(t){super.init(t),this.assign=k(t[this.constructor.otname],[T])}get input_name(){return this.assign.var}get input_value(){return this.assign.val}set input_value(t){}}u(ut,"otname","ot-input");class ht extends Z{init(t){super.init(t),this.onPageEvent("ot.update",this.onUpdate)}get input_name(){return this.elem.name}get input_value(){return this.elem.value}set input_value(t){this.elem.value=void 0!==t?t:null}onUpdate(t){this.ref.affected(t)&&(this.input_value=this.ref.value(j))}onReset(){super.onReset(),!this.elem.disabled&&this.elem.hasAttribute("autofocus")&&setTimeout((()=>this.elem.focus()))}}u(ht,"otname","ot-input");class mt extends ht{init(t){super.init(t),this.ref=k(t[this.constructor.otname],[w]),this.elem.name=this.ref.var,this.onElemEvent("keypress",this.onKey)}onKey(t,e){"Enter"==e.code&&(e.preventDefault(),this.submit())}onToggle(){super.onToggle(),!this.elem.disabled&&this.elem.hasAttribute("autofocus")&&setTimeout((()=>this.elem.focus()))}}class dt extends q{init(t){this.cond=k(t[this.constructor.otname],[w,x]),this.onPageEvent("ot.update",this.onUpdate),"ot-input"in t||this.onElemEvent("ot.toggleInput",this.onToggle),this.toggle(!1)}onUpdate(t){if(this.cond.affected(t)){let t=this.cond.eval(j);this.cond instanceof w?this.toggle(!n(t)):this.toggle(t)}}onToggle(){this.elem.disabled=this.elem.ot_disabled,this.elem.disabled?this.elem.setAttribute("disabled",""):this.elem.removeAttribute("disabled")}toggle(t){this.elem.ot_disabled=!t,this.emitElemEvent("ot.toggleInput")}}u(dt,"otname","ot-enabled");const ft=[[V],[G],[Q,"img[ot-img]"],[X],[st],[tt],[et],[nt],[it],[ot],[dt],[mt,"input[type=text][ot-input]"],[mt,"input[type=number][ot-input]"],[class extends ht{init(t){super.init(t),this.ref=k(t[this.constructor.otname],[T]),this.elem.name=this.ref.var,this.onElemEvent("click",this.onClick)}get input_value(){return this.elem.checked?this.ref.val:void 0}set input_value(t){this.elem.checked=t===this.ref.val}submit(){this.elem.checked&&super.submit()}onClick(){this.elem.disabled||(this.elem.blur(),this.onSubmit())}},"input[type=radio][ot-input]"],[class extends ht{init(t){super.init(t),this.ref=k(t[this.constructor.otname],[w]),this.elem.name=this.ref.var,this.onElemEvent("click",this.onClick)}get input_value(){return this.elem.checked}set input_value(t){this.elem.checked=Boolean(t)}onClick(){this.elem.disabled||(this.elem.blur(),this.onSubmit())}},"input[type=checkbox][ot-input]"],[ut,"[ot-input]:not(input, select)"],[lt],[ct],[rt],[at,"button[type=button]"]];var pt=Object.freeze({__proto__:null,keypath:p,otDirectiveBase:q,otInputBase:Z,registerDirective:function(t,e){ft.push([t,e])},affecting:v,Expr:b,EventExpr:E,VarExpr:w,WatchExpr:y,CmpExpr:x,AssignExpr:T,parseExpr:k,isArray:e,isFunction:function(t){return"function"==typeof t},isVoid:n,isHTMLElement:i,isScalar:o,isObject:s,isPlainObject:r,assertArgs:c});function vt(t){let e=JSON.parse(t.data);for(const[t,n]of Object.entries(e))l("live.".concat(t),n)}return window.addEventListener("load",(()=>{window.liveSocket&&(window.liveSocket.onmessage=vt),ft.forEach((t=>{let[e,n]=t;return function(t,e){void 0===e&&(e="[".concat(t.otname,"]")),document.querySelectorAll(e).forEach((e=>new t(e)))}(e,n)})),l("load")})),t.beginMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response";R(t),W(t)},t.cancelClock=function(t){J.cancel(t)},t.cancelSchedule=function(t){K.cancel(t)},t.cancelTimer=function(t){D.cancel(t)},t.clock=J,t.completePage=function(){c("completePage",arguments,[]),j.update(),setTimeout((()=>document.querySelector("form#form").requestSubmit()))},t.completeTrial=function(t){c("completeTrial",arguments,["object"]),l("completeTrial",t)},t.delay=async function(t,e){return new Promise(((n,i)=>{setTimeout((()=>{e&&(e(),j.update()),n()}),t)}))},t.delayEvent=function(t,e,n){c("delayEvent",arguments,["number","string","data"],["number","string"]);let i=new CustomEvent("ot.".concat(e),{detail:n});setTimeout((()=>document.body.dispatchEvent(i)),t)},t.dev=pt,t.emitEvent=l,t.endMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response";return F(t),H(t)},t.freezeInputs=function(){c("freezeInputs",arguments,[]),l("freezeInputs")},t.getMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response";return H(t)},t.loadImage=function(t){let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLImageElement&&(e=t),e.complete?Promise.resolve(e):new Promise(((t,n)=>{e.onload=()=>t(e),e.onerror=n}))},t.nextIteration=O,t.onClock=function(){c("onClock",arguments,["string","function"],["function"]);let{handler:t,match:e}=B(arguments);L("time",void 0!==e?function(n){"clock"==n.source&&n.name==e&&t(n.time)}:function(e){"clock"==e.source&&t(e.name,e.time)})},t.onComplete=function(t){c("onComplete",arguments,["function"]),L("completeTrial",t)},t.onEvent=L,t.onInput=function(){c("onInput",arguments,["string","function"],["function"]);let{handler:t,match:e}=U(arguments);L("input",void 0!==e?n=>{n.name==e&&t(n.value)}:e=>{t(e.name,e.value)})},t.onIteration=function(t){c("onIteration",arguments,["function"]),L("startIteration",t)},t.onLive=function(t,e){c("onLive",arguments,["string","function"]),L("live.".concat(t),e)},t.onLoad=function(t){c("onLoad",arguments,["function"]),L("load",t)},t.onReset=function(t,e){try{c("onReset",arguments,["string","function"])}catch(t){throw console.error(t),new Error("Invalid onReset usage")}let i;try{i=k(t,[y])}catch(t){throw console.error(t),new Error("Invalid onReset usage")}L("load",(function(){e()})),L("update",(function(t){if(i.affected(t)){n(i.eval(j))&&e()}}))},t.onSchedule=function(){c("onSchedule",arguments,["string","function"],["function"]);let{handler:t,match:e}=B(arguments);L("time",void 0!==e?function(n){"schedule"==n.source&&n.name==e&&t(n.time)}:function(e){"schedule"==e.source&&t(e.name,e.time)})},t.onTimeout=function(t){c("onTimeout",arguments,["function"]),L("time",(function(e){"timer"==e.source&&"timeout"==e.name&&t(e.time)}))},t.onTimer=function(){c("onTimer",arguments,["string","function"],["function"]);let{handler:t,match:e}=B(arguments);L("time",void 0!==e?function(n){"timer"==n.source&&n.name==e&&t(n.time)}:function(e){"timer"==e.source&&t(e.name,e.time)})},t.onTrial=function(t){c("onTrial",arguments,["function"]),L("startTrial",t)},t.onUpdate=function(){try{c("onUpdate",arguments,["string","function"],["function"])}catch(t){throw console.error(t),new Error("Invalid onUpdate usage")}let{handler:t,match:e}=U(arguments);if(void 0!==e){let i;try{i=k(e,[y])}catch(t){throw console.error(t),new Error("Invalid onUpdate usage")}L("update",(function(e){if(i.affected(e)){let e=i.eval(j);n(e)||t(e)}}))}else L("update",(function(e){t(e)}))},t.page=j,t.resetInputs=function(){c("resetInputs",arguments,[]),l("resetInputs")},t.schedule=K,t.sendLive=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;c("sendLive",arguments,["string","object"],["string"]),liveSocket.send(JSON.stringify({[t]:e}))},t.startClock=function(t){J.start(t)},t.startIteration=C,t.startSchedule=function(t){K.start(t)},t.startTimer=function(t){D.start(t)},t.startTrial=function(t){c("startTrial",arguments,["object"]),l("startTrial",t)},t.stopClock=function(){J.stop()},t.stopSchedule=function(){K.stop()},t.stopTimer=function(){D.stop()},t.submitInputs=function(){c("submitInputs",arguments,[]),l("submitInputs")},t.timer=D,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
