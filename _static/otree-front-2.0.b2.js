/*!
otree-front v2.0.b2
Microframework for interactive pages for oTree platform
(C) qwiglydee@gmail.com
https://github.com/oTree-org/otree-front
*/
var ot=function(t){"use strict";function e(t){return Array.isArray(t)}function i(t){return"function"==typeof t}function n(t){return null==t||Number.isNaN(t)}function s(t){var e=typeof t;return"string"===e||("number"===e||("boolean"===e||("symbol"===e||(null==t||(t instanceof Symbol||(t instanceof String||(t instanceof Number||t instanceof Boolean)))))))}function r(t){return"[object Object]"===Object.prototype.toString.call(t)}function o(t){var e,i;return!1!==r(t)&&(void 0===(e=t.constructor)||!1!==r(i=e.prototype)&&!1!==i.hasOwnProperty("isPrototypeOf"))}function a(t,n){return Array.from(t).every(((t,s)=>function(t,n){switch(n){case"any":return!0;case"array":return e(t);case"object":return r(t);case"class":return i(t);default:return typeof t===n}}(t,n[s])))}function c(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];if(0==n.filter((t=>t.length==e.length&&a(e,t))).length){const e=n.map((e=>"".concat(t,"(").concat(e.join(", "),")"))).join(" or ");throw new Error("Invalid arguments, expected: ".concat(e))}}function*u(t){let e=t.split(".");for(let t=0;t<e.length-1;t++)yield[e.slice(0,t+1).join("."),e.slice(t+1).join(".")]}function l(t){return s(t)||r(t)||e(t)||t instanceof HTMLElement}function m(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return function*(){if(""!=i&&l(t)&&(yield[i,n(t)?null:t]),o(s=t)||e(s))for(let[e,n]of Object.entries(t))l(n)&&(yield*m(n,i?"".concat(i,".").concat(e):e));var s}()}class h extends Map{affect(t){let e=t.endsWith(".*"),i=e?t.slice(0,-2):t;if(this.has(i))return!0;for(let[t,e]of u(i))if(this.has(t))return!0;if(e){let t=i+".";for(let e of this.keys())if(e.startsWith(t))return!0}return!1}extract(t){let e=t.endsWith(".*")?t.slice(0,-2):t;if(this.has(e))return this.get(e);for(let[t,s]of u(e))if(this.has(t))return i=this.get(t),"string"==typeof(n=s)&&(n=n.split(".")),n.reduce(((t,e)=>t&&e in t?t[e]:void 0),i);var i,n}}function d(t,e){let i=new Set([].concat(Array.from(t.keys()),Array.from(e.keys()))),n=Array.from(i).filter((i=>t.get(i)!==e.get(i)));return n=n.filter((t=>{return!(e=t,Array.from(u(e)).map((t=>t[0]))).some((t=>n.includes(t)));var e})),new h(n.map((t=>[t,e.has(t)?e.get(t):null])))}function p(){let t=(e=window.vars,new Map(m(e)));var e;let i=d(window.ot_snapshot,t);i.size&&(window.ot_snapshot=t,document.body.dispatchEvent(new CustomEvent("ot.update",{detail:{changes:i}})))}function f(t,e){c("triggerEvent",arguments,["string"],["string","object"]),document.body.dispatchEvent(new CustomEvent("ot.".concat(t),{detail:e}))}function v(t){f("submitted"),t.preventDefault(),document.getElementById("form").checkValidity()&&setTimeout((()=>g()))}function g(){HTMLFormElement.prototype.submit.call(document.getElementById("form"))}function y(t){return"#".concat(t)}function b(t){return"[id|=".concat(t.slice(0,-2),"]")}function w(t){return"[name=".concat(t,"]")}function E(t){return"".concat(w(t),",").concat(y(t))}function x(t){return t.endsWith("-*")?b(t):y(t)}function A(t){return t.endsWith("-*")?b(t):E(t)}function k(t,i){return e(i)||(i=[i]),i.map((e=>function(t,e){let i=t(e),n=document.querySelectorAll(i);if(!n.length)throw Error("No elements found for: ".concat(e));return Array.from(n).map((t=>[i,t]))}(t,e))).flat()}function T(){let t="[name]";return Array.from(document.querySelectorAll(t)).map((e=>[t,e]))}function I(t){return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement}function P(t){return["radio","checkbox"].includes(t.type)}function C(t){t.setAttribute("hidden","")}function M(t){t.removeAttribute("hidden")}function j(t){t.setAttribute("disabled","")}function S(t){t.removeAttribute("disabled")}function D(t,e){return t.forEach((t=>{let[i,n]=t;return e(n)}))}function L(t){let e=t.map((t=>t[0])).join(","),i=document.querySelector("[autofocus]:enabled:is(".concat(e,"), *:is(").concat(e,") [autofocus]:enabled"));i&&i.focus()}class O{constructor(t){this.name=t,this.started=0,this.counter=0,this.handler=null}start(){this.started=Date.now(),this.counter=0,window.ot_timers[this.name]=this}elapsed(){return Date.now()-this.started}cancel(){window.clearTimeout(this.handler),delete window.ot_timers[this.name]}}class _ extends O{constructor(t,e){super(t),this.timeout=e}start(){super.start(),this.handler=window.setTimeout((()=>{f("timer",{name:this.name,elapsed:this.elapsed(),count:1})}),this.timeout)}}class N extends O{constructor(t,e,i){super(t),this.period=e,this.count=i}start(){super.start(),this.handler=window.setTimeout((()=>{f("timer",{name:this.name,elapsed:this.elapsed(),count:0}),this.restart()}),0)}restart(){this.handler=window.setInterval((()=>{this.counter+=1,f("timer",{name:this.name,elapsed:this.elapsed(),count:this.counter}),this.count&&this.counter>=this.count&&this.cancel()}),this.period)}}class V extends O{constructor(t,e){super(t),this.intervals=e}start(){super.start(),this.handler=window.setTimeout((()=>{f("timer",{name:this.name,elapsed:this.elapsed(),count:0}),this.restart()}),0)}restart(){this.handler=window.setTimeout((()=>{this.counter+=1,f("timer",{name:this.name,elapsed:this.elapsed(),count:this.counter}),this.counter>=this.intervals.length?this.cancel():this.restart()}),this.intervals[this.counter])}}function q(){window.ot_timers={}}function H(t){c("cancelTimer",arguments,["string"]),t in window.ot_timers&&window.ot_timers[t].cancel()}function W(t){return c("preloadImage",arguments,["string"]),new Promise(((e,i)=>{let n=new Image;n.loading="eager",n.src=t,n.onload=()=>e(n)}))}function R(t,e){return t.forEach((t=>{let[i,n]=t;return e(n)}))}function B(t){P(t)?t.checked=t.defaultChecked:t.value=t.defaultValue,t.dispatchEvent(new Event("ot.reset"))}function F(t){t.dispatchEvent(new Event("ot.commit"))}function K(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class z{constructor(t){K(this,"params",{}),this.elem=t}get hidden(){return this.elem.hasAttribute("hidden")||null!=this.elem.closest("[hidden]")}get disabled(){return this.elem.hasAttribute("disabled")}get focused(){return this.elem===document.activeElement}get active(){return!this.hidden&&!this.disabled}init(){}render(){}update(t){this.render()}reset(){this.render()}commit(t){void 0===t&&(t=this.value),this.triggerPageEvent("input",{name:this.name,value:t})}initParams(){this.paramVars={};for(let t in this.params){let e=this.params[t],i=this.elem.getAttribute(e.attr||t);"string"==typeof i&&i.startsWith("vars.")&&(this.paramVars[t]=i.slice(5),i=void 0),this[t]=n(i)?e.default:i}}updateParams(t){let e=Object.entries(this.paramVars).filter((e=>{let[i,n]=e;return t.affect(n)}));return e.forEach((e=>{let[i,n]=e;return this[i]=t.extract(n)})),new Set(e.map((t=>{let[e,i]=t;return e})))}onEvent(t,e,i){t.addEventListener(e,(t=>{try{i.call(this,t)}catch(e){console.error(e),console.error("Failed to handle '".concat(t.type,"' for ").concat(this.constructor.name," at"),this.elem)}}))}onPageEvent(t,e){this.onEvent(document.body,"ot.".concat(t),e)}onElemEvent(t,e){this.onEvent(this.elem,t,e)}triggerElemEvent(t){let e=new Event(t);this.elem.dispatchEvent(e)}triggerPageEvent(t,e){let i=new CustomEvent("ot.".concat(t),{detail:e});i.source=this.elem,document.body.dispatchEvent(i)}}class U extends z{init(){this.initParams(),this.render(),this.onPageEvent("update",this.onUpdate)}onUpdate(t){let e=t.detail.changes,i=this.updateParams(e);i.size&&this.update(i)}}class X extends z{get value(){return this.elem.value}set value(t){this.elem.value=t}init(){if(!I(this.elem))throw Error("This directive is for native inputs only");if(!this.elem.hasAttribute("name"))throw Error("Missing `name` attribute");this.name=this.elem.getAttribute("name"),this.elem.setAttribute("input",""),this.initParams(),this.render(),this.onElemEvent("change",this.onChange),this.onElemEvent("ot.commit",this.onCommit),this.onElemEvent("ot.reset",this.onReset)}onChange(){this.active&&(this.reset(),this.commit())}onCommit(){this.commit()}onReset(){this.reset()}}class Y extends z{init(){this.combined=void 0!==Array.from(Object.values(this.elem.ot)).find((t=>t instanceof X||t instanceof Z)),this.combined||(this.name=this.elem.getAttribute("name"),this.elem.value=this.elem.getAttribute("value"),this.elem.defaultValue=this.elem.value),this.initParams()}trigger(){this.active&&(this.combined?this.triggerElemEvent("ot.commit"):this.commit(this.elem.value))}}class Z extends z{get value(){return this.input?this.input.value:this.elem.value}set value(t){this.input?this.input.value=t:this.elem.value=t}init(){if(I(this.elem))throw Error("This directive is not for native inputs");if(!this.elem.hasAttribute("name")&&!this.elem.hasAttribute("input"))throw Error("Missing `name` or `input` attribute");if(this.params.value||(this.params.value={}),this.elem.hasAttribute("input")){if(this.name=this.elem.getAttribute("input"),this.input=document.querySelector("input[name=".concat(this.name,"]")),!this.input)throw Error("Linked input not found: ".concat(this.name));this.input.hasAttribute("value")&&(this.params.value.default=this.input.defaultValue)}else this.name=this.elem.getAttribute("name");this.initParams(),this.input?this.input.defaultValue=this.value:this.elem.defaultValue=this.value,this.render(),this.onPageEvent("update",this.onUpdate),this.onElemEvent("ot.commit",this.onCommit),this.input?(this.onEvent(this.input,"change",this.onChange),this.onEvent(this.input,"ot.reset",this.onReset)):this.onEvent(this.elem,"ot.reset",this.onReset)}onUpdate(t){let e=t.detail.changes,i=this.updateParams(e);i.size&&this.update(i)}onChange(){this.active&&(this.reset(),this.commit())}onCommit(){this.commit()}onReset(){this.reset()}}function G(t,e){c("attachDirective",arguments,["class","string"]),document.querySelectorAll(e).forEach((e=>{void 0===e.ot&&(e.ot={});try{let i=new t(e);i.init(),e.ot[t.name]=i}catch(i){console.error(i),console.error("Failed to create directive ".concat(t.name," at"),e)}}))}class J extends U{constructor(){super(...arguments),K(this,"params",{val:{attr:"ot-text"}})}render(){n(this.val)?this.elem.textContent="":this.elem.textContent=this.val}}class Q extends U{constructor(){super(...arguments),K(this,"params",{val:{attr:"ot-html"}})}render(){n(this.val)?this.elem.innerHTML="":this.elem.innerHTML=this.val}}class $ extends U{constructor(){super(...arguments),K(this,"attr","foo"),K(this,"params",{val:{attr:"ot-foo"}})}render(){n(this.val)?this.elem.removeAttribute(this.attr):this.elem.setAttribute(this.attr,this.val)}}class tt extends ${constructor(){super(...arguments),K(this,"attr","min"),K(this,"params",{val:{attr:"ot-min"}})}}class et extends ${constructor(){super(...arguments),K(this,"attr","max"),K(this,"params",{val:{attr:"ot-max"}})}}class it extends ${constructor(){super(...arguments),K(this,"attr","step"),K(this,"params",{val:{attr:"ot-step"}})}}class nt extends ${constructor(){super(...arguments),K(this,"attr","width"),K(this,"params",{val:{attr:"ot-width"}})}}class st extends ${constructor(){super(...arguments),K(this,"attr","height"),K(this,"params",{val:{attr:"ot-height"}})}}class rt extends ${constructor(){super(...arguments),K(this,"attr","href"),K(this,"params",{val:{attr:"ot-href"}})}}class ot extends ${constructor(){super(...arguments),K(this,"attr","src"),K(this,"params",{val:{attr:"ot-src"}})}}class at extends U{constructor(){super(...arguments),K(this,"params",{val:{attr:"ot-class"}})}init(){this.initial=Array.from(this.elem.classList),super.init()}render(){let t=this.initial.slice();n(this.val)||(Array.isArray(this.val)?t=t.concat(this.val):t.push(this.val)),this.elem.classList.remove(...this.elem.classList),this.elem.classList.add(...t)}}class ct extends U{constructor(){super(...arguments),K(this,"params",{val:{attr:"ot-value"}})}update(){n(this.val)?this.elem.value=null:this.elem.value=this.val,this.triggerElemEvent("ot.reset")}}class ut extends X{}class lt extends X{constructor(){super(...arguments),K(this,"params",{autocommit:{default:null}})}init(){super.init(),this.onElemEvent("keypress",this.onKey),""==this.autocommit&&(this.autocommit=350),this.autocommit&&this.onElemEvent("input",this.onAutocommit)}commit(){"number"==this.elem.type?super.commit(Number(this.value)):super.commit()}onKey(t){"Enter"===t.key&&t.preventDefault()}onAutocommit(){this.commit_timeout&&window.clearTimeout(this.commit_timeout),this.commit_timeout=window.setTimeout((()=>this.commit()),this.autocommit)}}class mt extends X{commit(){super.commit(Number(this.value))}}class ht extends X{commit(){this.elem.checked&&super.commit()}}class dt extends X{commit(){"on"==this.elem.value?super.commit(this.elem.checked):super.commit(this.elem.checked?this.value:null)}}class pt extends Y{init(){super.init(),this.onElemEvent("click",this.onClick)}onClick(){this.active&&this.trigger()}}class ft extends Y{constructor(){super(...arguments),K(this,"params",{key:{attr:"ot-key-input"}})}init(){if(super.init(),1!=this.key.length&&!this.key.match(/[A-Z]\w+/))throw new Error('Invalid key name: "'.concat(this.key,'", expected a letter or a codename.'));this.onEvent(document.body,"keypress",this.onKey)}onKey(t){!this.active||this.key!=t.key&&this.key!=t.code||(t.preventDefault(),t.stopImmediatePropagation(),this.trigger())}}class vt extends z{init(){super.init(),this.name=this.elem.getAttribute("name"),this.onElemEvent("click",this.onClick)}onClick(t){this.active&&this.commit({x:t.offsetX,y:t.offsetY})}}return window.addEventListener("DOMContentLoaded",(()=>{G(J,"[ot-text]"),G(Q,"[ot-html]"),G(tt,"[ot-min]"),G(et,"[ot-max]"),G(it,"[ot-step]"),G(nt,"[ot-width]"),G(st,"[ot-height]"),G(ot,"[ot-src]"),G(rt,"[ot-href]"),G(at,"[ot-class]"),G(ct,"[ot-value]"),G(lt,"input[ot-input]:is([type=text],[type=number])"),G(lt,"textarea[ot-input]"),G(mt,"input[ot-input][type=range]"),G(ht,"input[ot-input][type=radio]"),G(dt,"input[ot-input][type=checkbox]"),G(ut,"input[ot-input]:not([type=text],[type=number],[type=range],[type=radio],[type=checkbox])"),G(ut,"select[ot-input]"),G(vt,"[ot-point-input]"),G(ft,"[ot-key-input]"),G(pt,"[ot-click-input]"),window.vars={},window.ot_snapshot=new Map,document.getElementById("form").addEventListener("submit",v),q()})),window.addEventListener("load",(()=>{f("loaded")})),t.ContentDirective=U,t.DirectiveBase=z,t.NativeInput=X,t.TriggerInput=Y,t.WidgetDirective=Z,t.attachDirective=G,t.beginTimeMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"measurement";c("beginTimeMeasurement",arguments,[],["string"]),function(t){window.performance.clearMarks("ot.".concat(t,".begin")),window.performance.clearMarks("ot.".concat(t)),window.performance.clearMeasures("ot.".concat(t,".measure"))}(t),function(t){window.performance.mark("ot.".concat(t,".begin"))}(t)},t.cancelTimer=H,t.cancelTimers=function(t){c("cancelTimers",arguments,[],["string"],["array"]),void 0===t&&(t=Array.from(Object.keys(window.ot_timers))),e(t)||(t=[t]);for(let e of t)H(e)},t.commitInput=function(t){c("commitInput",arguments,["string"]);let e=document.querySelectorAll("[input=".concat(t,"]")),i=document.querySelectorAll("[name=".concat(t,"]"));if(e.length)e.forEach(F);else{if(!i.length)throw Error("No inputs found: ".concat(t));i.forEach(F)}},t.completePage=function(){g()},t.delay=async function(t){return p(),new Promise(((e,i)=>{window.setTimeout((()=>e()),t)}))},t.delayEvent=function(t,e,i){c("delayEvent",arguments,["number","string"],["number","string","object"]),setTimeout((()=>document.body.dispatchEvent(new CustomEvent("ot.".concat(e),{detail:i}))),t)},t.disableElem=j,t.disableInput=function(t){c("disableInput",arguments,["string"]),D(k(E,t),j)},t.disableInputs=function(t){c("disableInputs",arguments,["string"],["array"],[]),D(void 0===t?T():k(A,t),j)},t.emitEvent=function(t,e){c("emitEvent",arguments,["string"],["string","object"]),setTimeout((()=>document.body.dispatchEvent(new CustomEvent("ot.".concat(t),{detail:e}))))},t.enableElem=S,t.enableInput=function(t){c("enableInput",arguments,["string"]);let e=k(E,t);D(e,S),L(e)},t.enableInputs=function(t){c("enableInputs",arguments,["string"],["array"],[]);let e=void 0===t?T():k(A,t);D(e,S),L(e)},t.getTimeMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"measurement";return c("getTimeMeasurement",arguments,[],["string"]),function(t){window.performance.mark("ot.".concat(t))}(t),Math.round(function(t){return window.performance.measure("ot.".concat(t,".measure"),"ot.".concat(t,".begin"),"ot.".concat(t))}(t).duration)},t.hideDisplay=function(t){c("hideDisplay",arguments,["string"]),D(k(y,t),C)},t.hideDisplays=function(t){c("hideDisplays",arguments,["string"],["array"]),D(k(x,t),C)},t.hideElem=C,t.initTimers=q,t.isArray=e,t.isElemCheckable=P,t.isElemEditable=function(t){return["text","textarea","email","tel","date","time","datetime-local","url","number"].includes(t.type)},t.isElemField=I,t.isElemNavigable=function(t){return-1!=t.tabIndex},t.isFunction=i,t.isObject=r,t.isPlainObject=o,t.isScalar=s,t.isVoid=n,t.onEvent=function(t,e,i){c("onEvent",arguments,["string","function"],["string","string","function"],["string","function","function"]),2==arguments.length?(i=arguments[1],e=null):"string"==typeof arguments[1]&&(e=t=>t.detail&&t.detail.name==arguments[1]),document.body.addEventListener("ot.".concat(t),(async n=>{e&&!e(n)||(await i.call(null,n),"update"!==t&&p())}))},t.otCheckInput=dt,t.otClass=at,t.otClick=pt,t.otHTML=Q,t.otHeight=st,t.otHref=rt,t.otInput=ut,t.otKey=ft,t.otMax=et,t.otMin=tt,t.otPoint=vt,t.otRadioInput=ht,t.otRangeInput=mt,t.otSrc=ot,t.otStep=it,t.otText=J,t.otTextInput=lt,t.otValue=ct,t.otWidth=nt,t.preloadImage=W,t.preloadImages=function(t){return c("preloadImage",arguments,["array"]),Promise.all(t.map((t=>W(t))))},t.resetInput=function(t){c("resetInput",arguments,["string"]),R(k(w,t),B)},t.resetInputs=function(t){c("resetInputs",arguments,[],["array"]),R(void 0===t?T():k(w,t),B)},t.showDisplay=function(t){c("showDisplay",arguments,["string"]);let e=k(y,t);D(e,M),L(e)},t.showDisplays=function(t){c("showDisplays",arguments,["string"],["array"]);let e=k(x,t);D(e,M),L(e)},t.showElem=M,t.startTimer=function(t,e){c("startTimer",arguments,["string","number"]),H(t),new _(t,e).start()},t.startTimerPeriodic=function(t,e,i){c("startTimerPeriodic",arguments,["string","number","number"],["string","number"]),H(t),new N(t,e,i).start()},t.startTimerSequence=function(t,e){c("startTimerSequence",arguments,["string","array"]),H(t),new V(t,e).start()},t.submitPage=function(){document.getElementById("form").requestSubmit()},t.triggerEvent=f,t.updatePage=p,t}({});Object.freeze(ot);
