/*!
otree-front v1.1.1
microframework for interactive pages for oTree platform
(C) qwiglydee@gmail.com
https://github.com/qwiglydee/otree-front
*/
var ot=function(t){"use strict";function e(t){return Array.isArray(t)}function n(t){return null==t||Number.isNaN(t)}function i(t){return Object.prototype.toString.call(t).startsWith("[object HTML")}function o(t){var e=typeof t;return"string"===e||("number"===e||("boolean"===e||("symbol"===e||(null==t||(t instanceof Symbol||(t instanceof String||(t instanceof Number||t instanceof Boolean)))))))}function s(t){return"[object Object]"===Object.prototype.toString.call(t)}function r(t){var e,n;return!1!==s(t)&&(void 0===(e=t.constructor)||!1!==s(n=e.prototype)&&!1!==n.hasOwnProperty("isPrototypeOf"))}function a(t,n){return Array.from(t).every(((t,i)=>function(t,n){switch(n){case"data":return!0;case"array":return e(t);case"object":return s(t);default:return typeof t===n}}(t,n[i])))}function c(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];if(0==i.filter((t=>t.length==e.length&&a(e,t))).length){const e=i.map((e=>"".concat(t,"(").concat(e.join(", "),")"))).join(" or ");throw new Error("Invalid arguments, expected: ".concat(e))}}function l(t,e){c("emitEvent",arguments,["string","data"],["string"]);let n=new CustomEvent("ot.".concat(t),{detail:e});setTimeout((()=>document.body.dispatchEvent(n)))}function u(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const m=/^[a-zA-Z]\w+(\.\w+)*$/;function h(t,e){return e==t||e.startsWith(t+".")}function d(t,e){return h(t,e)||e.endsWith(".*")&&t.startsWith(e.slice(0,-2))}function f(t,e){return e.endsWith(".*")&&(e=e.slice(0,-2)),e.split(".").reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}var p=Object.freeze({__proto__:null,affects:d,extract:f,includes:h,length:function(t){return t.split(".").length},update:function(t,e,n){const i=e.split("."),o=i.slice(0,-1),s=i.slice(-1)[0];let r=o.length?function(t,e){return e.reduce(((t,e)=>t&&e in t?t[e]:void 0),t)}(t,o):t;if(void 0===r)throw new Error("Unreachable keypath ".concat(e));r[s]=n},validate:function(t){return t.match(m)}});function v(t,e){return Array.from(t.keys()).some((t=>d(t,e)))}const g="([a-zA-Z]\\w+(\\.\\w+)*)";class b{static match(t){if(t.match(this.banned))throw new Error("banned expression");let e=t.match(this.regexp);if(!e)throw new Error("invalid expression");return e}affected(t){return v(t,this.var)}value(t){return f(t,this.var)}}u(b,"regexp",new RegExp("^"+g+"$")),u(b,"banned",new RegExp("^(true|false|null|undefined)$"));class E extends b{constructor(t){super();let e=this.constructor.match(t);this.name=e[1]}}u(E,"description","event name");class w extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1]}eval(t){return this.value(t)}}u(w,"description","variable");class y extends w{constructor(t){t.endsWith(".*")?(super(t.slice(0,-2)),this.nested=!0):(super(t),this.nested=!1)}affected(t){return this.nested?v(t,this.var+".*"):v(t,this.var)}}u(y,"description","variable watch");class x extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1],this.cmp=e[3],this.val=JSON.parse(e[4].replaceAll("'",'"')),!0!==this.val&&!1!==this.val&&null!==this.val||(this.cmp+="=")}eval(t){let e=this.value(t);if(null==e||Number.isNaN(e))return!1;switch(this.cmp){case"==":return e==this.val;case"!=":return e!=this.val;case"===":return e===this.val;case"!==":return e!==this.val}}}u(x,"description","comparision"),u(x,"regexp",new RegExp("^"+g+" (==|!=) (.+)$"));class T extends b{constructor(t){super();let e=this.constructor.match(t);this.var=e[1],this.val=JSON.parse(e[3].replaceAll("'",'"'))}}function I(t,e){for(let n of e)try{return new n(t)}catch(t){continue}let n=e.map((t=>t.description)).join(" or ");throw new Error('Invalid expression: "'.concat(t,'", expected: ').concat(n))}function k(t){return o(t)||s(t)||e(t)||i(t)}function _(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return function*(){if(""!=i&&k(t)&&(yield[i,n(t)?null:t]),r(o=t)||e(o))for(let[e,n]of Object.entries(t))k(n)&&(yield*_(n,i?"".concat(i,".").concat(e):e));var o}()}u(T,"description","assignment"),u(T,"regexp",new RegExp("^"+g+" = (.+)$"));let A=new Map;const S={update(){let t=new Map(_(this));let e=function(t,e){let n=new Map,i=[],o=new Set;for(let e of t.keys())o.add(e);for(let t of e.keys())o.add(t);for(let s of o){if(i.some((t=>h(t,s))))continue;let o=t.get(s),r=e.get(s);r!==o&&(n.set(s,void 0===r?null:r),i.push(s))}return n}(A,t);0!=e.size&&(A=t,l("update",e))}};function P(t,e){c("onEvent",arguments,["string","function"]),document.body.addEventListener("ot.".concat(t),(async t=>{await e(t.detail,t),S.update()}))}function L(t){return 2==t.length?{match:t[0],handler:t[1]}:{match:void 0,handler:t[0]}}function j(){c("onInput",arguments,["string","function"],["function"]);let{handler:t,match:e}=L(arguments);P("input",void 0!==e?n=>{n.name==e&&t(n.value)}:e=>{t(e.name,e.value)})}function C(t,e){try{c("onReset",arguments,["string","function"])}catch(t){throw console.error(t),new Error("Invalid onReset usage")}let i;try{i=I(t,[y])}catch(t){throw console.error(t),new Error("Invalid onReset usage")}P("load",(function(){e()})),P("update",(function(t){if(i.affected(t)){n(i.eval(S))&&e()}}))}function U(){try{c("onUpdate",arguments,["string","function"],["function"])}catch(t){throw console.error(t),new Error("Invalid onUpdate usage")}let{handler:t,match:e}=L(arguments);if(void 0!==e){let i;try{i=I(e,[y])}catch(t){throw console.error(t),new Error("Invalid onUpdate usage")}P("update",(function(e){if(i.affected(e)){let e=i.eval(S);n(e)||t(e)}}))}else P("update",(function(e){t(e)}))}function z(t){c("onLoad",arguments,["function"]),P("load",t)}function O(t){c("startIteration",arguments,[]),l("startIteration",t)}const M=O;function N(t){c("onIteration",arguments,["function"]),P("startIteration",t)}function R(t){c("onTrial",arguments,["function"]),P("startTrial",t)}function W(t){c("onComplete",arguments,["function"]),P("completeTrial",t)}function F(t){return"otree.".concat(t,".beg")}function H(t){return"otree.".concat(t,".end")}function B(t){return"otree.".concat(t,".measure")}function $(t){return performance.getEntriesByName(B(t))[0].duration}function D(t){return 2==t.length?{match:t[0],handler:t[1]}:{match:void 0,handler:t[0]}}class J{constructor(){this.timers={},this.schedule={},this.started=null}now(){return Math.floor(performance.now()-this.started)}start(t){this.stop(),this.schedule=t,this.started=performance.now();for(let e in t)this.startTimer(e)}startTimer(t){let e=this.schedule[t];this.timers[t]=window.setTimeout((()=>this.emitTimer(t)),e)}emitTimer(t){l("time",{time:this.now(),name:t,source:"timer"})}stop(){this.started=null;for(let t in this.timers)window.clearTimeout(this.timers[t]),delete this.timers[t]}cancel(t){window.clearTimeout(this.timers[t]),delete this.timers[t]}}const K=new J;const q=new class extends J{start(t){this.stop();for(let e in t)l("time",{time:0,name:e,source:"clock"});super.start(t)}emitTimer(t){l("time",{time:this.now(),name:t,source:"clock"}),super.startTimer(t)}};const Z=new class extends J{start(t){this.stop();let e={},n=0;for(let i in t)e[i]=n,n+=t[i];super.start(e)}emitTimer(t){l("time",{time:this.now(),name:t,source:"schedule"})}};function V(){c("onTimer",arguments,["string","function"],["function"]);let{handler:t,match:e}=D(arguments);P("time",void 0!==e?function(n){"timer"==n.source&&n.name==e&&t(n.time)}:function(e){"timer"==e.source&&t(e.name,e.time)})}function G(){c("onClock",arguments,["string","function"],["function"]);let{handler:t,match:e}=D(arguments);P("time",void 0!==e?function(n){"clock"==n.source&&n.name==e&&t(n.time)}:function(e){"clock"==e.source&&t(e.name,e.time)})}function Q(){c("onSchedule",arguments,["string","function"],["function"]);let{handler:t,match:e}=D(arguments);P("time",void 0!==e?function(n){"schedule"==n.source&&n.name==e&&t(n.time)}:function(e){"schedule"==e.source&&t(e.name,e.time)})}class X{constructor(t){this.elem=t;let e=Object.fromEntries(Array.from(this.elem.attributes).map((t=>[t.name,t.value])));try{this.init(e)}catch(t){console.error(t),console.error("Failed to initialize ".concat(this.constructor.name," at"),this.elem)}}init(t){}onElemEvent(t,e){this.elem.addEventListener(t,function(n){try{e.call(this,n.detail,n)}catch(e){console.error(e),console.error("Failed to ".concat(t," ").concat(this.constructor.name," at"),this.elem)}}.bind(this))}onPageEvent(t,e){document.body.addEventListener(t,function(n){try{e.call(this,n.detail,n)}catch(e){console.error(e),console.error("Failed to ".concat(t," ").concat(this.constructor.name," at"),this.elem)}}.bind(this))}emitElemEvent(t){let e=new CustomEvent(t,{detail:arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,bubbles:arguments.length>2&&void 0!==arguments[2]&&arguments[2]});setTimeout((()=>this.elem.dispatchEvent(e)))}}class Y extends X{init(t){this.var=I(t["ot-attr-".concat(this.constructor.attrname)],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(S);null==t?this.elem.removeAttribute(this.constructor.attrname):this.elem.setAttribute(this.constructor.attrname,t)}}}u(Y,"attrname","");class tt extends Y{}u(tt,"attrname","value");class et extends Y{}u(et,"attrname","min");class nt extends Y{}u(nt,"attrname","max");class it extends Y{}u(it,"attrname","height");class ot extends Y{}u(ot,"attrname","width");class st extends X{init(t){this.onPageEvent("ot.resetInputs",this.onReset),this.onPageEvent("ot.freezeInputs",this.onFreeze),this.onPageEvent("ot.submitInputs",this.onSubmit),this.onElemEvent("ot.submitInput",this.onSubmit),this.onElemEvent("ot.toggleInput",this.onToggle),this.elem.ot_frozen=!1,this.onToggle()}get input_name(){}get input_value(){}set input_value(t){}onReset(){this.input_value=null,this.elem.ot_frozen=!1,this.onToggle()}onFreeze(){this.elem.ot_frozen=!0,this.onToggle()}onToggle(){this.elem.disabled=this.elem.ot_disabled||this.elem.ot_frozen,this.elem.disabled?(this.elem.setAttribute("disabled",""),this.elem.blur()):this.elem.removeAttribute("disabled")}onSubmit(){this.elem.disabled||this.submit()}submit(){l("input",{name:this.input_name,value:this.input_value})}}class rt extends X{init(t){let e=t["ot-click"];if(void 0!==e&&""!==e)throw new Error('Invalid attribute value: "'.concat(e,'", expected: none'));this.onElemEvent("click",this.onClick)}onClick(){this.elem.disabled||this.emitElemEvent("ot.submitInput")}}class at extends st{init(t){super.init(t),this.onPageEvent("ot.update",this.onUpdate)}get input_name(){return this.elem.name}get input_value(){return this.elem.value}set input_value(t){this.elem.value=void 0!==t?t:null}onUpdate(t){this.ref.affected(t)&&(this.input_value=this.ref.value(S))}onReset(){super.onReset(),!this.elem.disabled&&this.elem.hasAttribute("autofocus")&&setTimeout((()=>this.elem.focus()))}}class ct extends at{init(t){if(super.init(t),this.ref=I(t["ot-input"],[w]),this.elem.name=this.ref.var,"autocommit"in t){if(this.autocommit=""!=t.autocommit?parseInt(t.autocommit):250,isNaN(this.autocommit))throw new Error("Invalid autocommit value, expected empty or number of ms")}else this.autocommit=!1;this.autocommit_timer=null,this.onElemEvent("keypress",this.onKey),this.autocommit&&this.onElemEvent("input",this.onInput)}scheduleAutocommit(){this.cancelAutocommit(),this.autocommit_timer=setTimeout((()=>this.submit()),this.autocommit)}cancelAutocommit(){this.autocommit_timer&&clearTimeout(this.autocommit_timer),this.autocommit_timer=null}onKey(t,e){"Enter"==e.code&&(e.preventDefault(),this.submit())}onInput(t,e){"Enter"!=e.code&&this.scheduleAutocommit()}onToggle(){super.onToggle(),this.cancelAutocommit(),!this.elem.disabled&&this.elem.hasAttribute("autofocus")&&setTimeout((()=>this.elem.focus()))}}const lt=[[class extends X{init(t){this.var=I(t["ot-text"],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(S);this.elem.textContent=null!=t?t:""}}},"[ot-text]"],[class extends X{init(t){this.var=I(t["ot-html"],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(S);this.elem.innerHTML=null!=t?t:""}}},"[ot-html]"],[class extends X{init(t){this.ref=I(t["ot-img"],[w]),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.ref.affected(t)){let t=this.ref.eval(S);if(null==t)this.replace(new Image);else{if(!(t instanceof HTMLImageElement))throw new Error('Invalid content for "page.'.concat(this.ref.var,'", expected preloaded HTMLImage, use `ot.loadImage`'));this.replace(t)}}}replace(t){for(let e of this.elem.attributes)"src"!=e.name&&t.setAttribute(e.name,e.value);this.elem.replaceWith(t),this.elem=t}},"img[ot-img]"],[class extends X{init(t){this.var=I(t["ot-class"],[w]),this.defaults=Array.from(this.elem.classList),this.onPageEvent("ot.update",this.onUpdate)}onUpdate(t){if(this.var.affected(t)){let t=this.var.eval(S);this.elem.classList.remove(...this.elem.classList),this.elem.classList.add(...this.defaults),t&&this.elem.classList.add(t)}}},"[ot-class]"],[class extends X{init(t){this.cond=I(t["ot-if"],[w,x]),this.onPageEvent("ot.update",this.onUpdate),this.toggle(!1)}onUpdate(t){if(this.cond.affected(t)){let t=this.cond.eval(S);this.cond instanceof w?this.toggle(!n(t)):this.toggle(t)}}toggle(t){this.elem.hidden=!t}},"[ot-if]"],[tt,"[ot-attr-value]"],[et,"[ot-attr-min]"],[nt,"[ot-attr-max]"],[it,"[ot-attr-height]"],[ot,"[ot-attr-width]"],[class extends X{init(t){this.cond=I(t["ot-enabled"],[w,x]),this.onPageEvent("ot.update",this.onUpdate),"ot-input"in t||this.onElemEvent("ot.toggleInput",this.onToggle),this.toggle(!1)}onUpdate(t){if(this.cond.affected(t)){let t=this.cond.eval(S);this.cond instanceof w?this.toggle(!n(t)):this.toggle(t)}}onToggle(){this.elem.disabled=this.elem.ot_disabled,this.elem.disabled?this.elem.setAttribute("disabled",""):this.elem.removeAttribute("disabled")}toggle(t){this.elem.ot_disabled=!t,this.emitElemEvent("ot.toggleInput")}},"[ot-enabled]"],[ct,"input[type=text][ot-input]"],[ct,"input[type=number][ot-input]"],[class extends at{init(t){super.init(t),this.ref=I(t["ot-input"],[T]),this.elem.name=this.ref.var,this.onElemEvent("click",this.onClick)}get input_value(){return this.elem.checked?this.ref.val:void 0}set input_value(t){this.elem.checked=t===this.ref.val}submit(){this.elem.checked&&super.submit()}onClick(){this.elem.disabled||(this.elem.blur(),this.onSubmit())}},"input[type=radio][ot-input]"],[class extends at{init(t){super.init(t),this.ref=I(t["ot-input"],[w]),this.elem.name=this.ref.var,this.onElemEvent("click",this.onClick)}get input_value(){return this.elem.checked}set input_value(t){this.elem.checked=Boolean(t)}onClick(){this.elem.disabled||(this.elem.blur(),this.onSubmit())}},"input[type=checkbox][ot-input]"],[class extends st{init(t){super.init(t),this.assign=I(t["ot-input"],[T])}get input_name(){return this.assign.var}get input_value(){return this.assign.val}set input_value(t){}},"[ot-input]:not(input, select)"],[class extends X{init(t){let e=I(t["ot-emit"],[E]);this.event_name=e.name,this.onElemEvent("ot.toggleInput",this.onToggle),this.onElemEvent("ot.submitInput",this.onSubmit)}onToggle(){this.elem.disabled=this.elem.ot_disabled,this.elem.disabled?this.elem.setAttribute("disabled",""):(this.elem.removeAttribute("disabled"),this.elem.blur())}onSubmit(){this.elem.disabled||l(this.event_name)}},"[ot-emit]"],[class extends X{init(t){let e=t["ot-key"];if(1!=e.length&&!e.match(/[A-Z]\w+/))throw new Error('Invalid attribute value: "'.concat(e,'", see "Code values for keyboard" at developer.mozilla.org'));this.keycode=e,this.onPageEvent("keydown",this.onKey)}onKey(t,e){this.elem.disabled||this.keycode!=e.key&&this.keycode!=e.code||(e.preventDefault(),this.emitElemEvent("ot.submitInput"))}},"[ot-key]"],[rt,"[ot-click]"],[class extends rt{onClick(){this.elem.disabled||(this.emitElemEvent("ot.submitInput"),this.elem.blur())}},"button[type=button]"]];var ut=Object.freeze({__proto__:null,AssignExpr:T,CmpExpr:x,EventExpr:E,Expr:b,VarExpr:w,WatchExpr:y,affecting:v,assertArgs:c,isArray:e,isFunction:function(t){return"function"==typeof t},isHTMLElement:i,isObject:s,isPlainObject:r,isScalar:o,isVoid:n,keypath:p,otAttr:Y,otDirectiveBase:X,otInputBase:st,parseExpr:I,registerDirective:function(t,e){lt.push([t,e])}});function mt(t){let e=JSON.parse(t.data);for(const[t,n]of Object.entries(e))l("live.".concat(t),n)}function ht(t,e){c("onLive",arguments,["string","function"]),P("live.".concat(t),e)}const dt={onLoad:z,onIteration:N,onTrial:R,onComplete:W},ft={onEvent:P,onInput:j,onReset:C,onUpdate:U,onLive:ht,onTimer:V,onClock:G,onSchedule:Q};return window.addEventListener("load",(()=>{window.liveSocket&&(window.liveSocket.onmessage=mt),lt.forEach((t=>{let[e,n]=t;return function(t,e){document.querySelectorAll(e).forEach((e=>new t(e)))}(e,n)})),function(t){for(let e in dt)window[t][e]!==dt[e]&&console.error("Invalid usage of ".concat(e,", expected: ").concat(t,".").concat(e,"(function)"));for(let e in ft)window[t][e]!==ft[e]&&console.error("Invalid usage of ".concat(e,", expected: ").concat(t,".").concat(e,"(function) or ").concat(t,".").concat(e,'("name", function)'))}("ot"),l("load")})),t.beginMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response";!function(t){performance.clearMarks(F(t)),performance.clearMarks(H(t)),performance.clearMeasures(B(t))}(t),function(t){performance.mark(F(t))}(t)},t.cancelClock=function(t){q.cancel(t)},t.cancelSchedule=function(t){Z.cancel(t)},t.cancelTimer=function(t){K.cancel(t)},t.clock=q,t.completePage=function(){c("completePage",arguments,[]),S.update(),setTimeout((()=>document.querySelector("form#form").requestSubmit()))},t.completeTrial=function(t){c("completeTrial",arguments,["object"]),l("completeTrial",t)},t.delay=async function(t,e){return new Promise(((n,i)=>{setTimeout((()=>{e&&(e(),S.update()),n()}),t)}))},t.delayEvent=function(t,e,n){c("delayEvent",arguments,["number","string","data"],["number","string"]);let i=new CustomEvent("ot.".concat(e),{detail:n});setTimeout((()=>document.body.dispatchEvent(i)),t)},t.dev=ut,t.emitEvent=l,t.endMeasurement=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response";return function(t){performance.mark(H(t)),performance.measure(B(t),F(t),H(t))}(t),$(t)},t.freezeInputs=function(){c("freezeInputs",arguments,[]),l("freezeInputs")},t.getMeasurement=function(){return $(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"response")},t.loadImage=function(t){let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLImageElement&&(e=t),e.complete?Promise.resolve(e):new Promise(((t,n)=>{e.onload=()=>t(e),e.onerror=n}))},t.nextIteration=M,t.onClock=G,t.onComplete=W,t.onEvent=P,t.onInput=j,t.onIteration=N,t.onLive=ht,t.onLoad=z,t.onReset=C,t.onSchedule=Q,t.onTimeout=function(t){c("onTimeout",arguments,["function"]),P("time",(function(e){"timer"==e.source&&"timeout"==e.name&&t(e.time)}))},t.onTimer=V,t.onTrial=R,t.onUpdate=U,t.page=S,t.resetInputs=function(){c("resetInputs",arguments,[]),l("resetInputs")},t.schedule=Z,t.sendLive=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;c("sendLive",arguments,["string","object"],["string"]),liveSocket.send(JSON.stringify({[t]:e}))},t.startClock=function(t){q.start(t)},t.startIteration=O,t.startSchedule=function(t){Z.start(t)},t.startTimer=function(t){K.start(t)},t.startTrial=function(t){c("startTrial",arguments,["object"]),l("startTrial",t)},t.stopClock=function(){q.stop()},t.stopSchedule=function(){Z.stop()},t.stopTimer=function(){K.stop()},t.submitInputs=function(){c("submitInputs",arguments,[]),l("submitInputs")},t.timer=K,t}({});
