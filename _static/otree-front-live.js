/**
 * Helpers to communicate with backend driven by `utils/live.py`
 *
 * Live communication happens in form of messages that have type and payload.
 */


if (!window.liveSocket) {
    throw new Error("otree-front-live.js doesn't see live socket")
}

/**
 * Handling live communication according to type+data paradigm.
 * Each message generated by  is converted into an event
 *
 * @event live
 * @property {object} detail
 * @property {string} detail.name type of a message
 * @property {any} detail.data message payload
 */
window.liveSocket.onmessage = function (e) {
    let data = JSON.parse(e.data);
    if (!ot.isArray(data)) throw new Error("live socket received invalid data")
    for (let msg of data) {
        if (!ot.isObject(msg) || !Object.hasOwn(msg, 'type')) throw new Error("live socket received invalid data")
        ot.emitEvent('live', { name: msg.type, data: msg.data });
    }
}

/**
 * Warapper for a live handler.
 *
 * @example
 * ot.onEvent('live', onLive(handleLive));
 * ot.onEvent('live', 'type', onLive(handleLive));
 *
 * function handleLive(type, data) { ... }
 */
function onLive(handler) {
    return (e) => handler(e.detail.name, e.detail.data);
}


/**
 * Sending live message of a given type.
 *
 * @example
 * sendLive(type, payload)
 *
 * @param {string} type type of the message
 * @param {object} [data] message payload
 */
function sendLive(type, data) {
    window.liveSocket.send(JSON.stringify({ type, data }))
}