{{ block content }}

<header>
    <my-progress ticks="1" max="vars.progress.total" value="vars.progress.completed" value2="vars.trial.iteration">
    </my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.fading">
    <div class="fs-1 m-3" ot-text="vars.trial.expression"></div>

    <canvas class="m-3" width="{{C.CANVAS_SIZE.0}}" height="{{C.CANVAS_SIZE.1}}"
            my-draw-input name="answer" feather="{{C.CANVAS_FEATHER}}" color="#000000"></canvas>

    <button type="button" class="btn btn-primary" ot-input name="commit">Submit</button>
</main>

<footer>
    <p ot-display="prompt">Draw your answer on the canvas and press <kbd>Submit</kbd>.</p>
    <p ot-display="feedback">You <i ot-text="vars.gain_txt"></i></p>
    <p ot-display="retry">Your answer is not accepted, try again.</p>
    <div ot-display="spinner" class="spinner-ellipsis"><i></i><i></i><i></i></div>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'enhancements.css' }}">
<link rel="stylesheet" href="{{ static 'xfade.css' }}">
<link rel="stylesheet" href="{{ static 'progress2.css' }}">
<link rel="stylesheet" href="{{ static 'spinner-pulse.css' }}">
<style>
    canvas {
        border: 2px solid rgba(0, 0, 0, .5);
        border-radius: .25rem;
        background: #f8f9fa;
        box-shadow: 0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);
    }
</style>
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>
<script src="{{ static 'drawing-input.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>
<script>
    "use strict";

    const TRIAL_DELAY = js_vars.C.TRIAL_DELAY;
    const RETRY_DELAY = js_vars.C.RETRY_DELAY;
    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade.css

    ot.onStartPage(startGame);
    ot.onLive('progress', updateProgress);
    ot.onLive('trial', startTrial);
    ot.onInput('answer', inputAnswer);
    ot.onInput('commit', function() { ot.commitInput('answer'); });
    ot.onLive('feedback', completeTrial);
    ot.onDelete('vars.feedback', displayFeedback);
    ot.onUpdate('vars.feedback', displayFeedback);
    ot.onLive('failure', function (message) { alert(message); ot.completePage(); });

    function startGame() {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};
        vars.fading = "hidden";
        nextIter();
    };

    function updateProgress(progress) {
        if (vars.progress.terminated === undefined && progress.terminated) ot.completePage(); // occasionally reloaded alreay completed page
        vars.progress = progress;
    };

    function nextIter() {
        if (vars.progress.terminated) {
            ot.completePage();
        } else {
            ot.sendLive('iter'); // expecting live progress and trial
        }
    }

    function startTrial(trial) {
        vars.trial = trial;
        vars.response = null;
        vars.feedback = null;
        ot.switchDisplays({ only: 'prompt' });
        ot.resetInputs();
        ot.enableInputs();
        ot.startTimeMeasurement();
        vars.fading = "fadein";
    };

    function retryTrial() {
        vars.response = null;
        vars.feedback = null;
        ot.switchDisplays({ only: 'prompt' });
        ot.resetInputs();
        ot.enableInputs();
    };

    function inputAnswer(image) {
        ot.disableInputs();
        ot.hideDisplays('prompt');

        vars.response = image;

        ot.sendLive('response', { // expecting live feedback and progress
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            response: image,
        });
    };

    function completeTrial(feedback) {
        vars.feedback = feedback;

        if (feedback.completed) {
            ot.showDisplays(['feedback', 'spinner']);
            ot.delay(TRIAL_DELAY - FADEOUT_TIME, function () { ot.hideDisplays(['feedback', 'spinner']); vars.fading = "fadeout"; });
            ot.delay(TRIAL_DELAY, function () { nextIter(); });
        } else {
            ot.showDisplays(['retry', 'spinner']);
            ot.delay(RETRY_DELAY, function () {  ot.hideDisplays(['retry', 'spinner']); retryTrial(); });
        }
    };

    /** adjusting styles and text for feedback */
    function displayFeedback(feedback) {
        if (feedback) {
            vars.gain_txt = format_gain(feedback.score);
        } else {
            vars.gain_txt = null;
        }
    }
</script>
{{ endblock }}