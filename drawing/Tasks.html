{{ block styles }}
<link href="{{ static 'fullscreen.css' }}" rel="stylesheet">
<link href="{{ static 'enhancements.css' }}" rel="stylesheet">
<link href="{{ static 'xfade.css' }}" rel="stylesheet">
<link href="{{ static 'progress2.css' }}" rel="stylesheet">
<link href="{{ static 'spinner-pulse.css' }}" rel="stylesheet">
<style>
    /* shuld be fixed size to avoid readjusting page layout when changing */
    footer {
        height: 10rem;
    }

    canvas {
        border: 2px solid rgba(0, 0, 0, .5);
        background: #f8f9fa;
        box-shadow: 0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);
    }
</style>
{{ endblock }}

{{ block content }}

<header>
    <my-progress max="{{C.NUM_TRIALS}}" ticks="1" value="vars.progress.completed"
        value2="vars.trial.iteration"></my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.fading">
    <div class="fs-1 m-3" ot-text="vars.trial.expression"></div>

    <canvas class="m-3" width="{{C.CANVAS_SIZE.0}}" height="{{C.CANVAS_SIZE.1}}"
            my-draw-input name="drawing" feather="{{C.CANVAS_FEATHER}}" color="#000000"></canvas>

    <button type="button" class="btn btn-primary" ot-input name="commit">Submit</button>
</main>

<footer>
    <p ot-display="prompt">Draw your answer on the canvas and press <kbd>Submit</kbd>.</p>
    <p ot-display="feedback">You <i ot-text="vars.gain_txt"></i></p>
    <p ot-display="retry">Your answer <b ot-text="vars.response"></b> is not accepted, try again.</p>
    <div ot-display="spinner" class="spinner-ellipsis"><i></i><i></i><i></i></div>
</footer>


{{ endblock }}

{{ block scripts }}

<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>
<script src="{{ static 'drawing-input.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.feedback_delay;  // delay after a trial
    const RETRY_DELAY = js_vars.retry_delay;  // delay after a retry
    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade css

    ot.onStartPage(function () {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};

        ot.sendLive('next');
        // expecting live trial and progress, or termination
    });

    ot.onLive('progress', function (progress) {
        vars.progress = progress;
    });

    ot.onLive('trial', function (trial) {
        vars.trial = trial;
        vars.fading = "fadein";
        ot.startTimeMeasurement();
        ot.emitEvent('trial.start');
    });

    ot.onEvent('trial.start', function() {
        vars.response = null;
        vars.feedback = null;
        ot.switchDisplays({ only: 'prompt' });
        ot.resetInputs();
        ot.enableInputs();
    });

    ot.onInput('commit', function () {
        ot.commitInput('drawing');
    });

    ot.onInput('drawing', function (image) {
        ot.disableInputs();
        ot.hideDisplays('prompt');

        ot.sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            image: image,
        });
        // expecting live feedback and progress
    });

    ot.onLive('feedback', function (feedback) {
        vars.feedback = feedback;
        if (feedback.completed) {
            ot.emitEvent('trial.complete');
        } else {
            ot.emitEvent('trial.resume');
        }
    });

    ot.onEvent('trial.resume', function() {
        ot.showDisplays('retry');
        ot.showDisplays('spinner');
        ot.delay(RETRY_DELAY, function() {
            ot.hideDisplays('spinner');
            ot.emitEvent('trial.start');
        });
    });

    ot.onEvent('trial.complete', function() {
        ot.showDisplays('feedback');
        ot.showDisplays('spinner');
        ot.delay(FEEDBACK_DELAY - FADEOUT_TIME, function () {
            vars.fading = "fadeout";
        });
        ot.delay(FEEDBACK_DELAY, function () {
            ot.hideDisplays('spinner');
            ot.sendLive('next');
        });
    });

    ot.onLive('terminate', function () {
        ot.completePage();
    });

    ot.onLive('failure', function (message) {
        alert(message);
        ot.completePage();
    });

    /* adjust style when feedback changes */
    ot.onDelete('vars.feedback', function () {
        vars.feedback_style = null;
    });
    ot.onUpdate('vars.feedback', function (feedback) {
        vars.feedback_style = feedback.success ? "is-valid" : "is-invalid";
        vars.gain_txt = format_gain(feedback.score);
    });
</script>

{{ endblock }}