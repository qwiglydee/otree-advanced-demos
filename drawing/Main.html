{{ block content }}

<header>
    <ot-progress ticks="1" max="vars.progress.total" val="vars.progress.completed" val2="vars.progress.current">
    </ot-progress>
    <div class="alert alert-secondary m-2">Total score: <b ot-text="vars.progress.score"></b></div>
    <p id="feedback-gain">You <i ot-text="vars.gain_txt"></i></p>
</header>

<main ot-fade>
    <img ot-src="vars.trial.image_url">

    <canvas ot-draw-input name="drawing" class="m-3 bg-light rounded border shadow"
        width="{{C.CANVAS_SIZE.0}}" height="{{C.CANVAS_SIZE.1}}" feather="{{C.FEATHER}}" color="{{C.COLOR}}">
    </canvas>

    <div class="d-flex gap-3">
        <button ot-click-input type="button" class="btn btn-primary" name="submit">Submit</button>
        <button ot-click-input type="button" class="btn btn-secondary" name="reset">Reset</button>
        <button ot-click-input type="button" class="btn btn-secondary" name="skip">Skip</button>
    </div>

</main>

<footer>
    <p id="guidance-prompt">Draw your image and click <kbd>Submit</kbd>.</p>
    <ot-pulse id="guidance-wait"></ot-pulse>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'otree-front-ext.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b1.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'ot-draw.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.C.FEEDBACK_DELAY;
    const FADEOUT_TIME = parseInt(getStyleProp("--ot-fade-out-time"));

    ot.onEvent('loaded', startGame);
    ot.onEvent('live', 'progress', onLive(liveProgress));
    ot.onEvent('live', 'trial', onLive(startTrial));
    ot.onEvent('input', 'drawing', onInput(inputDrawing));
    ot.onEvent('input', 'submit', onInput(submitDrawing));
    ot.onEvent('input', 'reset', onInput(resetDrawing));
    ot.onEvent('input', 'skip', onInput(skipTrial));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'failure', onLive(function (_, message) { alert(message); ot.submitPage(); }));

    function startGame() {
        ot.disableInputs();
        vars.progress = {};
        nextIter();
        // expecting live trial and progress...
    };

    function liveProgress(name, data) {
        vars.progress = data;
    };

    function nextIter() {
        resetTrial();
        ot.switchDisplays("guidance-wait");
        ot.disableInputs();

        if (vars.progress.terminated) {
            ot.submitPage();
        } else {
            sendLive('iter');
            // expecting live trial and progress...
        }
    }

    function resetTrial() {
        vars.trial = null;
        ot.resetInputs();
    }

    function startTrial(name, data) {
        vars.trial = data;
        fadeIn();
        ot.switchDisplays("guidance-prompt");
        ot.enableInputs();
        ot.beginTimeMeasurement();
    }

    function resetDrawing() {
        ot.resetInput('drawing');
    }

    function submitDrawing() {
        ot.commitInput('drawing');
    }

    function inputDrawing(name, value) {
        ot.switchDisplays("guidance-wait");
        ot.disableInputs();

        sendLive('drawing', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            drawing: value
        });
        // expecting live feedback and progress...
    };

    function skipTrial() {
        ot.switchDisplays("guidance-wait");
        ot.disableInputs();

        sendLive('drawing', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
        });
    }

    async function liveFeedback(name, data) {
        vars.feedback = data;

        displayFeedback();
        await ot.delay(FEEDBACK_DELAY);
        clearFeedback();

        fadeOut();
        await ot.delay(FADEOUT_TIME);

        nextIter();
    };

    function clearFeedback() {
        vars.gain_txt = null;
        ot.switchDisplays('feedback-none');
    }

    function displayFeedback() {
        vars.gain_txt = format_gain(vars.feedback.score);
        ot.showDisplays('feedback-gain');
    }


</script>
{{ endblock }}