{{ block content }}

<header>
    <ot-progress ticks="1" max="vars.progress.total" value="vars.progress.completed" value2="vars.progress.current">
    </ot-progress>
    <div class="alert alert-secondary m-2">Total score: <b ot-text="vars.progress.score"></b></div>
    <p id="gain">You <i ot-text="vars.gain_txt"></i></p>
</header>

<main id="main" class="ot-fade d-flex" hidden>
    <div class="fs-1 m-3">
        <span ot-text="vars.trial.expression"></span>
        =
        <span ot-text="vars.inputs.answer" ot-class="vars.feedback_style" class="answer"></span>
    </div>

    <ot-stacked>
        <section ot-stage="A" class="bg-light border rounded p-3 ot-fade">
            <p>Enter your answer</p>
            <input ot-input type="number" name="answer" class="form-control" autofocus autocommit ot-stage="A">
            <button ot-click-input ot-key-input="Enter" type="button" name="submit" value="A"
                class="btn btn-primary m-3" ot-stage="A">Next</button>
        </section>

        <section ot-stage="C" class="bg-light border rounded p-3 ot-fade">
            <p>How confident you are in yor answer?</p>
            <input ot-input type="range" name="confidence" min="1" max="5" value="3" class="form-range" autofocus ot-stage="C">
            <button ot-click-input ot-key-input="Enter" type="button" name="submit" value="C" class="btn btn-primary m-3" ot-stage="C">Next</button>
        </section>

        <section ot-stage="D" class="bg-light border rounded p-3 ot-fade" hidden>
            <p>Assess difficulty of the task</p>
            <input ot-input type="range" name="difficulty" min="0" max="10" value="5" class="form-range" autofocus ot-stage="D">
            <button ot-click-input ot-key-input="Enter" type="button" name="submit" value="D" class="btn btn-primary m-3" ot-stage="D">Next</button>
        </section>
    </ot-stacked>

</main>

<footer>
    <p id="prompt">Enter or select your response, and press <b>Next</b> button or <kbd>Enter</kbd> key</p>
    <ot-pulse id="wait"></ot-pulse>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'otree-front-ext.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
<style>
    .answer {
        display: inline-block;
        min-width: 2em;
    }

    .answer:empty::before {
        content: "...";
    }

    section {
        margin: auto; /* make each centered */
    }

    section.active {
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }
</style>
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b2.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'ot-stage.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.C.FEEDBACK_DELAY;
    const FADEOUT_TIME = parseInt(getStyleProp("--ot-fade-out-time"));

    ot.onEvent('loaded', startGame);
    ot.onEvent('live', 'progress', onLive(liveProgress));
    ot.onEvent('live', 'trial', onLive(startTrial));
    ot.onEvent('input', 'answer', onInput(inputResponse));
    ot.onEvent('input', 'confidence', onInput(inputResponse));
    ot.onEvent('input', 'difficulty', onInput(inputResponse));
    ot.onEvent('input', 'submit', onInput(submitResponse));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'failure', onLive(function (_, message) { alert(message); ot.completePage(); }));

    function startGame() {
        ot.disableInputs();
        vars.progress = {};
        nextIter();
        // expecting live trial and progress...
    };

    function liveProgress(name, data) {
        vars.progress = data;
    };

    function nextIter() {
        ot.disableInputs();
        resetTrial();

        if (vars.progress.terminated) {
            ot.completePage();
        } else {
            sendLive('iter');
            // expecting live trial and progress...
        }
    }

    function resetTrial() {
        vars.trial = null;
        vars.inputs = {};
        vars.feedback = null;
        switchStage(null);
        clearFeedback();
        ot.resetInputs();
    }

    function startTrial(name, data) {
        vars.trial = data;

        ot.showDisplay("main");
        ot.showDisplay("prompt");
        ot.hideDisplay("wait");

        switchStage('A');

        ot.disableInput("submit");
        ot.beginTimeMeasurement();
    }

    function inputResponse(name, value) {
        // save all inputs until last stage
        vars.inputs[name] = value;
        ot.enableInput("submit");
    }

    function submitResponse(name, stagename) {
        ot.disableInputs();

        if (stagename == "A") {
            sendLive('answer', {
                iteration: vars.trial.iteration,
                time: ot.getTimeMeasurement(),
                answer: vars.inputs.answer,
            });
        }

        if (stagename == "C") {
            sendLive('confidence', {
                iteration: vars.trial.iteration,
                confidence: vars.inputs.confidence,
            });
        }

        if (stagename == "D") {
            sendLive('difficulty', {
                iteration: vars.trial.iteration,
                difficulty: vars.inputs.difficulty
            });
        }
    };

    function liveFeedback(name, feedback) {
        vars.feedback = feedback;

        if (feedback.completed) {
            completeTrial();
        } else {
            switchStage(feedback.next);
        }
    }

    async function completeTrial() {
        switchStage(null);
        ot.hideDisplay("prompt");
        ot.showDisplay("wait");

        displayFeedback();
        await ot.delay(FEEDBACK_DELAY);
        clearFeedback();

        ot.hideDisplay("main");
        await ot.delay(FADEOUT_TIME);

        nextIter();
    };

    function clearFeedback() {
        ot.hideDisplay("gain");
        vars.feedback_style = null;
        vars.gain_txt = null;
    }

    function displayFeedback() {
        vars.feedback_style = vars.feedback.success ? "text-success" : "text-danger";
        vars.gain_txt = format_gain(vars.feedback.score);
        ot.showDisplay("gain");
    }

</script>
{{ endblock }}