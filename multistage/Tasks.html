{{ block content }}

<header>
    <my-progress ticks="1" max="vars.progress.total" value="vars.progress.completed" value2="vars.trial.iteration">
    </my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.fading">
    <div class="fs-1 m-3">
        <span ot-text="vars.trial.expression"></span>
        =
        <span ot-text="vars.response" ot-class="vars.feedback_style"></span>
    </div>

    <section ot-display="strategy" rounded class="rounded border bg-light p-3 m-3">
        <div class="d-flex flex-row gap-3 justify-content-evenly">
            <button type="button" class="btn btn-primary" ot-input name="strategy" value="choose" ot-enable="strategy">Choose</button>
            <button type="button" class="btn btn-primary" ot-input name="strategy" value="reduce" ot-enable="strategy">50:50</button>
            <button type="button" class="btn btn-primary" ot-input name="strategy" value="skip" ot-enable="strategy">Skip</button>
        </div>
    </section>

    <section ot-display="choices" class="rounded border bg-light p-3 m-3">
        <p>Select your answer</p>
        <div class="d-flex flex-row gap-3 justify-content-evenly">
            <button type="button" class="btn btn-big" ot-class="vars.styles.1" ot-input name="choice" value="1"
                ot-enable="choice-1" ot-text="vars.trial.options.1">
            </button>
            <button type="button" class="btn btn-big" ot-class="vars.styles.2" ot-input name="choice" value="2"
                ot-enable="choice-2" ot-text="vars.trial.options.2">
            </button>
            <button type="button" class="btn btn-big" ot-class="vars.styles.3" ot-input name="choice" value="3"
                ot-enable="choice-3" ot-text="vars.trial.options.3">
            </button>
            <button type="button" class="btn btn-big" ot-class="vars.styles.4" ot-input name="choice" value="4"
                ot-enable="choice-4" ot-text="vars.trial.options.4">
            </button>
        </div>
    </section>
</main>

<footer>
    <p ot-display="feedback">Correct answer is <b ot-text="vars.feedback.solution"></b>.</p>
    <p ot-display="feedback">You <i ot-text="vars.gain_txt"></i></p>
    <button ot-display="complete" type="button" class="btn btn-primary" ot-input name="complete">Continue</button>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'enhancements.css' }}">
<link rel="stylesheet" href="{{ static 'xfade.css' }}">
<link rel="stylesheet" href="{{ static 'progress2.css' }}">
<link rel="stylesheet" href="{{ static 'spinner-pulse.css' }}">
<style>
    canvas {
        border: 2px solid rgba(0, 0, 0, .5);
        border-radius: .25rem;
        background: #f8f9fa;
        box-shadow: 0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);
    }
</style>
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>
<script>
    "use strict";

    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade.css

    ot.onStartPage(startGame);
    ot.onLive('progress', updateProgress);
    ot.onLive('trial', startTrial);
    ot.onInput('choice', inputChoice);
    ot.onInput('strategy', inputStrategy);
    ot.onLive('feedback', continueTrial);
    ot.onInput('complete', completeIter);
    ot.onUpdate('vars.stage', switchStage);
    ot.onDelete('vars.choice', highlightChoice);
    ot.onUpdate('vars.choice', highlightChoice);
    ot.onDelete('vars.feedback', displayFeedback);
    ot.onUpdate('vars.feedback', displayFeedback);
    ot.onLive('failure', function (message) { alert(message); ot.completePage(); });

    function startGame() {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};
        vars.fading = "hidden";
        nextIter();
    };

    function updateProgress(progress) {
        if (vars.progress.terminated === undefined && progress.terminated) ot.completePage(); // occasionally reloaded alreay completed page
        vars.progress = progress;
    };

    function nextIter() {
        if (vars.progress.terminated) {
            ot.completePage();
        } else {
            ot.sendLive('iter'); // expecting live progress and trial
        }
    }

    function startTrial(trial) {
        vars.trial = trial;
        vars.choice = null;
        vars.response = null;
        vars.feedback = null;
        vars.choices = null;
        ot.resetInputs();
        ot.startTimeMeasurement();
        vars.fading = "fadein";

        if (trial.strategy == 'skip') {
            vars.stage = 'feedback';
        } else if (trial.strategy !== null) {
            vars.strategy = trial.strategy;
            vars.choices = trial.choices;
            vars.stage = 'choices';
        } else {
            vars.stage = 'strategy';
        }
    };

    function switchStage(stage) {
        switch (stage) {
            case 'strategy':
                ot.switchDisplays({ only: ['strategy', 'choices'] });
                ot.switchInputs({ only: 'strategy' });
                break;
            case 'choices':
                ot.switchDisplays({ only: 'choices' });
                ot.switchInputs({ only: vars.choices.map((i) => `choice-${i}`) });
                break;
            case 'feedback':
                ot.switchDisplays({ only: ['feedback', 'complete'] });
                ot.switchInputs({ only: 'complete' });
                break;
        }
    };

    function inputStrategy(strategy) {
        ot.disableInputs();

        vars.strategy = strategy

        ot.sendLive('strategy', {
            iteration: vars.trial.iteration,
            strategy: vars.strategy,
        });
    };

    function inputChoice(position) {
        ot.disableInputs();

        vars.choice = parseInt(position);
        vars.response = vars.trial.options[vars.choice];

        ot.sendLive('response', { // expecting live feedback and progress
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            choice: vars.choice,
        });
    };

    function continueTrial(feedback) {
        vars.feedback = feedback;

        if (feedback.choices !== undefined) {
            vars.choices = feedback.choices;
        }

        if (feedback.completed) {
            vars.stage = 'feedback';
        } else {
            vars.stage = 'choices';
        }
    };

    function completeIter() {
        vars.fading = "fadeout";
        ot.delay(FADEOUT_TIME, nextIter);
    };


    /** adjusting styles and text for feedback */
    function displayFeedback(feedback) {
        if (feedback && feedback.success !== undefined) {
            vars.feedback_style = feedback.success ? "text-success" : "text-danger";
            vars.gain_txt = format_gain(feedback.score);
        } else {
            vars.feedback_style = null;
            vars.gain_txt = null;
        }
    }

    /** adjust button styles after resposne */
    function highlightChoice(choice) {
        if (choice) {
            vars.styles = {
                1: "btn-light",
                2: "btn-light",
                3: "btn-light",
                4: "btn-light",
            }
            vars.styles[vars.choice] = "btn-dark";
        } else {
            vars.styles = {
                1: "btn-primary",
                2: "btn-primary",
                3: "btn-primary",
                4: "btn-primary",
            }
        }
    }
</script>
{{ endblock }}