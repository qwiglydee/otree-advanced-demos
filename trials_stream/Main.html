{{ block title }}
Task
{{ endblock }}

{{ block content }}

<header>
    <div class="flex-row">
        <div class="alert alert-info m-2">Trials: <span ot-text="progress.completed"></span></div>
        <div class="alert alert-success m-2">Score: <span ot-text="progress.score"></span></div>
        <div class="alert alert-danger m-2">Failures: <span ot-text="progress.failed"></span></div>
    </div>
</header>

<main ot-class="hiding">
    <div class="fs-1" ot-text="trial.question"></div>

    <div class="input-group">
        <input type="number" class="form-control" ot-class="feedback_style" ot-input="answer" autofocus>
    </div>
</main>

<footer>
    <div>Type solution to the equation and press <kbd>Enter</kbd></div>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'common.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-1.1.1.js' }}"></script>

<script>
    "use strict";

    const TRIAL_DELAY = js_vars.trial_delay;

    ot.onLoad(function () {
        const current = js_vars.current; // restoring current state
        ot.page.progress = {
            current: current.current,
            score: current.score,
            completed: current.completed,
            failed: current.failed,
        };

        ot.freezeInputs();

        if(current.trial) {
            ot.startTrial(current.trial)
        } else {
            ot.startIteration();
        }
    });

    ot.onIteration(function () {
        delete ot.page.trial;
        delete ot.page.response;
        delete ot.page.feedback;

        if (ot.page.progress.current != ot.page.progress.completed) {
            throw new Error("messed up with iterations");
        }

        ot.sendLive("iterate");
    });

    ot.onLive('progress', function (progress) {
        ot.page.progress.completed = progress.completed;
        ot.page.progress.failed = progress.failed;
        ot.page.progress.score = progress.score;
        if (progress.current) {
            ot.page.progress.current = progress.current;
        }
        if (progress.gameover == true) {
            ot.completePage();
        }
    });

    ot.onLive('trial', function(data) {
        ot.startTrial(data);
    });

    ot.onTrial(function (trial) {
        console.debug("trial", trial);
        ot.page.trial = trial;
        delete ot.page.hiding;
        ot.resetInputs();
        ot.beginMeasurement();
    });

    ot.onInput('answer', function (value) {
        console.debug("answer", value);
        ot.page.response = validateInput(value);
        // do not accept response if it's invalid (not a valid number)
        if (ot.page.response == undefined) return;

        let response_time = ot.endMeasurement();
        ot.freezeInputs();
        ot.sendLive('response', {
            iteration: ot.page.progress.current,
            response: ot.page.response,
            response_time
        });
    });

    function validateInput(val) {
        let num = parseInt(val);
        return Number.isNaN(num) ? undefined : num;
    }

    ot.onLive('feedback', function (data) {
        ot.completeTrial(data);
    });

    ot.onComplete(function (feedback) {
        ot.page.feedback = feedback;
        ot.delayEvent(TRIAL_DELAY - 200, "fadeout");
        ot.delayEvent(TRIAL_DELAY, 'startIteration');
    });

    ot.onEvent('fadeout', function () {
        ot.page.hiding = "hiding";
    });

    ot.onLive('failure', function (message) {
        alert(message);
        ot.completePage();
    });

    /* update feedback_style when feedback changes */
    ot.onReset('feedback', function () {
        delete ot.page.feedback_style;
    });
    ot.onUpdate('feedback.success', function (success) {
        ot.page.feedback_style = success ? "is-valid" : "is-invalid";
    });

</script>

{{ endblock }}