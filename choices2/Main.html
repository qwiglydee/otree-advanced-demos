{{ block content }}

<header>
    <ot-progress ticks="1" max="vars.progress.total" val="vars.progress.played" val2="vars.trial.iteration">
    </ot-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-fade>
    <div class="fs-1 m-3" ot-text="vars.trial.expression"></div>

    <div class="d-flex flex-row gap-3">
        <div class="form-check" ot-class="vars.styles.1">
            <input id="choice-1" type="checkbox" class="form-check-input" ot-input name="answer" value="1">
            <label for="choice-1" class="form-check-label" ot-text="vars.trial.options.1"></label>
        </div>
        <div class="form-check" ot-class="vars.styles.2">
            <input id="choice-2" type="radio" class="form-check-input" ot-input name="answer" value="2">
            <label for="choice-2" class="form-check-label" ot-text="vars.trial.options.2"></label>
        </div>
        <div class="form-check" ot-class="vars.styles.3">
            <input id="choice-3" type="radio" class="form-check-input" ot-input name="answer" value="3">
            <label for="choice-3" class="form-check-label" ot-text="vars.trial.options.3"></label>
        </div>
        <div class="form-check" ot-class="vars.styles.4">
            <input id="choice-4" type="radio" class="form-check-input" ot-input name="answer" value="4">
            <label for="choice-4" class="form-check-label" ot-text="vars.trial.options.4"></label>
        </div>
    </div>

    <button type="button" class="btn btn-primary m-3" ot-click-input name="confirm">Confirm</button>
</main>

<footer>
    <p id="prompt">Click on a button with your solution.</p>
    <p id="feedback-gain">You <i ot-text="vars.gain_txt"></i></p>
    <ot-pulse id="spinner"></ot-pulse>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'otree-front-ext.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b1.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.C.FEEDBACK_DELAY;
    const RETRY_DELAY = js_vars.C.RETRY_DELAY;
    const FADEOUT_TIME = parseInt(getStyleProp("--ot-fade-out-time"));

    ot.onEvent('loaded', startGame);
    ot.onEvent('live', 'progress', onLive(liveProgress));
    ot.onEvent('live', 'trial', onLive(liveTrial));
    ot.onEvent('input', 'answer', onInput(inputAnswer));
    ot.onEvent('input', 'confirm', onInput(confirmAnswer));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'failure', onLive(function (_, message) { alert(message); ot.submitPage(); }));

    function startGame() {
        ot.disableInputs();
        vars.progress = {};
        nextIter();
        // expecting live trial and progress...
    };

    function liveProgress(name, data) {
        vars.progress = data;
    };

    function nextIter() {
        if (vars.progress.terminated) {
            // postponed termination
            ot.submitPage();
        } else {
            sendLive('iter');
            // expecting live trial and progress...
        }
    }

    function liveTrial(name, data) {
        fadeIn();
        vars.trial = data;
        resetTrial();
        ot.beginTimeMeasurement();
    };

    function resetTrial() {
        vars.answer = null;
        vars.choice = null;
        clearFeedback();
        clearChoice();
        ot.resetInputs();
        document.querySelectorAll("[type=radio]").forEach(e => e.checked = false); // bug otree-front#22
        ot.enableInputs();
        ot.showDisplays('prompt');
    }

    function inputAnswer(name, position) {
        vars.choice = Number(position);
        vars.answer = vars.trial.options[position];
    }

    function confirmAnswer() {
        ot.disableInputs();
        ot.hideDisplays('prompt');
        highlightChoice();

        sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            answer: vars.answer
        });
        // expecting live feedback and progress...
    };


    async function liveFeedback(name, data) {
        vars.feedback = data;
        displayFeedback();

        if (vars.feedback.completed) {
            ot.showDisplays('spinner');
            await ot.delay(FEEDBACK_DELAY);
            fadeOut();
            await ot.delay(FADEOUT_TIME);
            ot.hideDisplays('spinner');
            clearFeedback();
            nextIter();
        } else {
            ot.showDisplays('spinner');
            await ot.delay(RETRY_DELAY);
            ot.hideDisplays('spinner');
            clearFeedback();
            resetTrial();
        }
    };

    function clearFeedback() {
        ot.hideDisplays('feedback-gain');
        vars.gain_txt = null;
    }

    function displayFeedback() {
        ot.showDisplays('feedback-gain');
        vars.gain_txt = format_gain(vars.feedback.score);
        vars.styles[vars.choice] = vars.feedback.success ? ["selected", "text-success"] : ["selected", "text-danger"];
    }

    function clearChoice() {
        vars.styles = {
            1: "text-primary",
            2: "text-primary",
            3: "text-primary",
            4: "text-primary",
        }
    }

    function highlightChoice() {
        vars.styles = {
            1: "text-secondary",
            2: "text-secondary",
            3: "text-secondary",
            4: "text-secondary",
        }
        vars.styles[vars.choice] = ["selected", "text-dark"];
    }

</script>
{{ endblock }}