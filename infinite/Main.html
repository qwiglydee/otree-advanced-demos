{{ block content }}

<header>
    <div class="alert alert-secondary m-2">Total score: <b ot-text="vars.progress.score"></b></div>
    <p id="gain">You <i ot-text="vars.gain_txt"></i></p>
</header>

<main id="main" class="ot-fade d-flex" hidden>
    <div class="fs-1 m-3" ot-text="vars.trial.expression"></div>

    <div class="input-group">
        <span class="input-group-text">=</span>
        <input ot-input type="number" name="answer" class="form-control" ot-class="vars.feedback_style" ot-key-input="Enter" autofocus>
    </div>
</main>

<footer>
    <p id="prompt">Enter your answer and press <kbd>Enter</kbd>.</p>
    <ot-pulse id="waiting"></ot-pulse>
</footer>

{{ endblock }}

{{ block styles }}
<link rel="stylesheet" href="{{ static 'fullscreen.css' }}">
<link rel="stylesheet" href="{{ static 'otree-front-ext.css' }}">
<link rel="stylesheet" href="{{ static 'ot-progress.css' }}">
{{ endblock }}

{{ block scripts }}
<script src="{{ static 'otree-front-2.0.b2.js' }}"></script>
<script src="{{ static 'otree-front-ext.js' }}"></script>
<script src="{{ static 'otree-front-live.js' }}"></script>
<script src="{{ static 'ot-progress.js' }}"></script>
<script src="{{ static 'format_score.js' }}"></script>

<script>
    "use strict";

    const FEEDBACK_DELAY = js_vars.C.FEEDBACK_DELAY;
    const FADEOUT_TIME = parseInt(getStyleProp("--ot-fade-out-time"));

    ot.onEvent('loaded', startGame);
    ot.onEvent('live', 'progress', onLive(updateProgress));
    ot.onEvent('live', 'trial', onLive(startTrial));
    ot.onEvent('input', 'answer', onInput(inputAnswer));
    ot.onEvent('live', 'feedback', onLive(liveFeedback));
    ot.onEvent('live', 'failure', onLive(function (_, message) { alert(message); ot.completePage(); }));

    function startGame() {
        vars.progress = {};
        nextIter();
    };

    function updateProgress(name, data) {
        Object.assign(vars.progress, data);
    };

    function nextIter() {
        resetTrial();

        if (vars.progress.terminated) {
            ot.completePage();
        } else {
            sendLive('next');
        }
    }

    function resetTrial() {
        vars.trial = null;
        vars.answer = null;
        vars.feedback = null;
        hideFeedback();
        ot.resetInputs();
        ot.disableInputs();
    }

    function startTrial(name, data) {
        vars.trial = data;

        ot.showDisplay("main");
        ot.showDisplay("prompt");

        ot.enableInputs();
        ot.beginTimeMeasurement();
    }

    function inputAnswer(name, value) {
        ot.disableInputs();

        ot.hideDisplay("prompt");

        vars.answer = value;

        sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            answer: vars.answer
        });
    };


    async function liveFeedback(name, data) {
        vars.feedback = data;

        ot.showDisplay("waiting");
        showFeedback();
        await ot.delay(FEEDBACK_DELAY);
        hideFeedback();
        ot.hideDisplay("waiting");

        completeTrial();
    };

    async function completeTrial() {
        ot.hideDisplay("main");
        await ot.delay(FADEOUT_TIME);
        nextIter();
    }

    function hideFeedback() {
        ot.hideDisplay("gain");
        vars.feedback_style = null;
        vars.gain_txt = null;
    }

    function showFeedback() {
        vars.feedback_style = vars.feedback.success ? "is-valid" : "is-invalid";
        vars.gain_txt = format_gain(vars.feedback.score);
        ot.showDisplay("gain");
    }

</script>
{{ endblock }}