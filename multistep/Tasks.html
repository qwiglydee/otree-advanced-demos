{{ block styles }}
<link href="{{ static 'fullscreen.css' }}" rel="stylesheet">
<link href="{{ static 'enhancements.css' }}" rel="stylesheet">
<link href="{{ static 'xfade.css' }}" rel="stylesheet">
<link href="{{ static 'progress2.css' }}" rel="stylesheet">
<style>
    /* shuld be fixed size to avoid readjusting page layout when changing */
    footer {
        height: 10rem;
    }

    /* redefine hidden style for sections to make it dimmed */
    section[hidden] {
        display: initial !important;
        opacity: 0.75;
    }

    section {
        opacity: 1.0;
        transition: opacity 150ms ease-in-out;
    }

    .range-check {
        display: flex;
        flex-flow: column;
        align-items: center;
    }
</style>
{{ endblock }}

{{ block content }}

<header>
    <my-progress max="{{C.NUM_TRIALS}}" ticks="1" value="vars.progress.completed"
        value2="vars.trial.iteration"></my-progress>
    <div class="alert alert-info m-2">Total score: <b ot-text="vars.progress.score"></b></div>
</header>

<main ot-class="vars.vars.fading">

    <div class="fs-1 m-3">
        <span ot-text="vars.trial.expression"></span>
        =
        <span ot-text="vars.response"></span>
    </div>


    <section ot-display="stage1" rounded class="rounded border bg-light p-3 m-3">
        <p>Select your answer</p>
        <div class="d-flex flex-row gap-3 justify-content-evenly">
            <button type="button" class="btn" ot-class="vars.styles.1" ot-input name="choice" value="1"
                ot-enable="choice" ot-text="vars.trial.choices.1">
            </button>
            <button type="button" class="btn" ot-class="vars.styles.2" ot-input name="choice" value="2"
                ot-enable="choice" ot-text="vars.trial.choices.2">
            </button>
            <button type="button" class="btn" ot-class="vars.styles.3" ot-input name="choice" value="3"
                ot-enable="choice" ot-text="vars.trial.choices.3">
            </button>
            <button type="button" class="btn" ot-class="vars.styles.4" ot-input name="choice" value="4"
                ot-enable="choice" ot-text="vars.trial.choices.4">
            </button>
        </div>
    </section>

    <section ot-display="stage2" class="rounded border bg-light p-3 m-3">
        <p>How confident are you in your answer?</p>

        <div class="d-flex flex-row gap-3 justify-content-evenly">
            <div class="range-check">
                <label for="c1">1</label>
                <input id="c1" class="form-check-input" type="radio" ot-input name="confidence" value="1">
            </div>
            <div class="range-check">
                <label for="c2">2</label>
                <input id="c2" class="form-check-input" type="radio" ot-input name="confidence" value="2">
            </div>
            <div class="range-check">
                <label for="c3">3</label>
                <input id="c3" class="form-check-input" type="radio" ot-input name="confidence" value="3">
            </div>
            <div class="range-check">
                <label for="c4">4</label>
                <input id="c4" class="form-check-input" type="radio" ot-input name="confidence" value="4">
            </div>
            <div class="range-check">
                <label for="c5">5</label>
                <input id="c5" class="form-check-input" type="radio" ot-input name="confidence" value="5">
            </div>
        </div>
    </section>
</main>

<footer>
    <p ot-display="feedback">Correct answer is <b ot-text="vars.feedback.solution"></b>.</p>
    <p ot-display="feedback">You gained <b ot-text="vars.feedback.score"></b> points</p>
    <button ot-display="continue" type="button" class="btn btn-primary" ot-input name="continue">Continue</button>
</footer>


{{ endblock }}

{{ block scripts }}

<script src="{{ static 'otree-front-1.5.b2.js' }}"></script>
<script src="{{ static 'progress2.js' }}"></script>

<script>
    "use strict";

    const FADEOUT_TIME = 200; // duration of fadeout animation from xfade css

    ot.onStartPage(function () {
        ot.disableInputs();
        ot.hideDisplays();
        vars.progress = {};

        ot.sendLive('start');
    });

    ot.onLive('progress', function (progress) {
        vars.progress = progress;
    });

    ot.onLive('trial', function (trial) {
        vars.trial = trial;
        vars.choice = null;
        vars.response = null;
        vars.feedback = null;

        vars.fading = "fadein";

        ot.resetInputs();
        ot.startTimeMeasurement();

        if (trial.response != null) {
            vars.choice = trial.choice;
            vars.response = trial.response;
            vars.stage = 2;
        } else {
            vars.stage = 1;
        }
    });

    ot.onUpdate('vars.stage', function (stage) {
        switch (stage) {
            case 1:
                ot.switchDisplays({ only: 'stage1' });
                ot.switchInputs({ only: 'choice' });
                break;
            case 2:
                ot.switchDisplays({ only: 'stage2' });
                ot.switchInputs({ only: 'confidence' });
                break;
            case 3:
                ot.switchDisplays({ only: ['feedback', 'continue'] });
                ot.switchInputs({ only: 'continue' });
                break;
        }
    });

    ot.onInput('choice', function (position) {
        ot.disableInputs();

        vars.choice = parseInt(position);
        vars.response = vars.trial.choices[position];

        ot.sendLive('response', {
            iteration: vars.trial.iteration,
            time: ot.getTimeMeasurement(),
            choice: vars.choice,
            response: vars.response,
        });
    });

    ot.onInput('confidence', function (value) {
        ot.disableInputs();

        vars.confidence = parseInt(value);

        ot.sendLive('response', {
            iteration: vars.trial.iteration,
            confidence: vars.confidence
        });
    });

    ot.onLive('feedback', function (feedback) {
        vars.feedback = feedback;
        vars.stage += 1;
    });

    ot.onInput('continue', function (value) {
        vars.fading = "fadeout";
        ot.delay(FADEOUT_TIME, function () {
            ot.sendLive('next');
        });
    });

    ot.onLive('terminate', function () {
        ot.completePage();
    });

    ot.onLive('failure', function (message) {
        alert(message);
        ot.completePage();
    });

    /* adjust style when feedback changes */
    ot.onDelete('vars.feedback', function () {
        vars.styles = {
            1: "btn-primary",
            2: "btn-primary",
            3: "btn-primary",
            4: "btn-primary",
        }
    });
    ot.onUpdate('vars.feedback', function (feedback) {
        if ('success' in feedback) {
            vars.styles[vars.choice] = feedback.success ? "btn-success" : "btn-danger";
        }
    });

    ot.onUpdate('vars.choice', function (choice) {
        console.debug("choice", choice)
        vars.styles = {
            1: "btn-light",
            2: "btn-light",
            3: "btn-light",
            4: "btn-light",
        }
        vars.styles[choice] = "btn-dark";
    });
</script>

{{ endblock }}